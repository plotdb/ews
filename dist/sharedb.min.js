!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).sharedb=t()}(function(){M=function(t,a){!function(n,c){!function(){var i=h.nextTick,t=Function.prototype.apply,r=Array.prototype.slice,o={},s=0;function e(t,e){this._id=t,this._clearFn=e}a.setTimeout=function(){return new e(t.call(setTimeout,window,arguments),clearTimeout)},a.setInterval=function(){return new e(t.call(setInterval,window,arguments),clearInterval)},a.clearTimeout=a.clearInterval=function(t){t.close()},e.prototype.unref=e.prototype.ref=function(){},e.prototype.close=function(){this._clearFn.call(window,this._id)},a.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},a.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},a._unrefActive=a.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;0<=e&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},a.setImmediate="function"==typeof n?n:function(t){var e=s++,n=!(arguments.length<2)&&r.call(arguments,1);return o[e]=!0,i(function(){o[e]&&(n?t.apply(null,n):t.call(null),a.clearImmediate(e))}),e},a.clearImmediate="function"==typeof c?c:function(t){delete o[t]}}.call(this)}.call(this,x({}).setImmediate,x({}).clearImmediate)};var M,e,x=function(t){return e||M(e={exports:{},parent:t},e.exports),e.exports},t={},n="object"==typeof Reflect?Reflect:null,j=n&&"function"==typeof n.apply?n.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};var F=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)},q=Number.isNaN||function(t){return t!=t};function i(){i.init.call(this)}(t=i).once=function(c,a){return new Promise(function(t,e){function n(t){c.removeListener(a,i),e(t)}function i(){"function"==typeof c.removeListener&&c.removeListener("error",n),t([].slice.call(arguments))}var r,o,s;z(c,a,i,{once:!0}),"error"!==a&&(o=n,s={once:!0},"function"==typeof(r=c).on&&z(r,"error",o,s))})},(i.EventEmitter=i).prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var B=10;function u(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function H(t){return void 0===t._maxListeners?i.defaultMaxListeners:t._maxListeners}function U(t,e,n,i){var r,o;return u(n),void 0===(r=t._events)?(r=t._events=Object.create(null),t._eventsCount=0):(void 0!==r.newListener&&(t.emit("newListener",e,n.listener||n),r=t._events),o=r[e]),void 0===o?(o=r[e]=n,++t._eventsCount):("function"==typeof o?o=r[e]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),0<(r=H(t))&&o.length>r&&!o.warned&&(o.warned=!0,(i=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",i.emitter=t,i.type=e,i.count=o.length,n=i,console&&console.warn&&console.warn(n))),t}function V(t,e,n){t={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},e=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(t);return e.listener=n,t.wrapFn=e}function Y(t,e,n){t=t._events;if(void 0===t)return[];t=t[e];{if(void 0===t)return[];if("function"==typeof t)return n?[t.listener||t]:[t];if(n){for(var i=t,r=new Array(i.length),o=0;o<r.length;++o)r[o]=i[o].listener||i[o];return r}return W(t,t.length)}}function G(t){var e=this._events;if(void 0!==e){e=e[t];if("function"==typeof e)return 1;if(void 0!==e)return e.length}return 0}function W(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}function z(n,i,r,o){if("function"==typeof n.on)o.once?n.once(i,r):n.on(i,r);else{if("function"!=typeof n.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n);n.addEventListener(i,function t(e){o.once&&n.removeEventListener(i,t),r(e)})}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return B},set:function(t){if("number"!=typeof t||t<0||q(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");B=t}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||q(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},i.prototype.getMaxListeners=function(){return H(this)},i.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var i="error"===t,r=this._events;if(void 0!==r)i=i&&void 0===r.error;else if(!i)return!1;if(i){if((o=0<e.length?e[0]:o)instanceof Error)throw o;i=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw i.context=o,i}var o=r[t];if(void 0===o)return!1;if("function"==typeof o)j(o,this,e);else for(var s=o.length,c=W(o,s),n=0;n<s;++n)j(c[n],this,e);return!0},i.prototype.on=i.prototype.addListener=function(t,e){return U(this,t,e,!1)},i.prototype.prependListener=function(t,e){return U(this,t,e,!0)},i.prototype.once=function(t,e){return u(e),this.on(t,V(this,t,e)),this},i.prototype.prependOnceListener=function(t,e){return u(e),this.prependListener(t,V(this,t,e)),this},i.prototype.off=i.prototype.removeListener=function(t,e){var n,i,r,o,s;if(u(e),void 0===(i=this._events))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,o=n.length-1;0<=o;o--)if(n[o]===e||n[o].listener===e){s=n[o].listener,r=o;break}if(r<0)return this;if(0===r)n.shift();else{var c=n;var a=r;for(;a+1<c.length;a++)c[a]=c[a+1];c.pop()}1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,s||e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){for(var i,r=Object.keys(n),o=0;o<r.length;++o)"removeListener"!==(i=r[o])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(o=e.length-1;0<=o;o--)this.removeListener(t,e[o]);return this},i.prototype.listeners=function(t){return Y(this,t,!0)},i.prototype.rawListeners=function(t){return Y(this,t,!1)},i.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):G.call(t,e)},i.prototype.listenerCount=G,i.prototype.eventNames=function(){return 0<this._eventsCount?F(this._events):[]};var c={},Q=t.EventEmitter;c.EventEmitter=Q,c.mixin=function(t){for(var e in Q.prototype)t.prototype[e]=Q.prototype[e]};var J=["info","warn","error"];function X(){var e={};J.forEach(function(t){e[t]=console[t].bind(console)}),this.setMethods(e)}X.prototype.setMethods=function(e){e=e||{};var n=this;J.forEach(function(t){"function"==typeof e[t]&&(n[t]=e[t])})};var a=new X,_={};function r(t,e){this.code=t,this.message=e||"",Error.captureStackTrace?Error.captureStackTrace(this,r):this.stack=(new Error).stack}((r.prototype=Object.create(Error.prototype)).constructor=r).prototype.name="ShareDBError",r.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED:"ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_APPLIED:"ERR_OT_OP_NOT_APPLIED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"};var o,s,_=r,y={},h=(y.defaultType=require("ot-json0").type,y.map={},y.register=function(t){t.name&&(y.map[t.name]=t),t.uri&&(y.map[t.uri]=t)},y.register(y.defaultType),{}),n=h={};function Z(){throw new Error("setTimeout has not been defined")}function K(){throw new Error("clearTimeout has not been defined")}function $(e){if(o===setTimeout)return setTimeout(e,0);if((o===Z||!o)&&setTimeout)return(o=setTimeout)(e,0);try{return o(e,0)}catch(t){try{return o.call(null,e,0)}catch(t){return o.call(this,e,0)}}}try{o="function"==typeof setTimeout?setTimeout:Z}catch(t){o=Z}try{s="function"==typeof clearTimeout?clearTimeout:K}catch(t){s=K}var l,p=[],f=!1,d=-1;function tt(){f&&l&&(f=!1,l.length?p=l.concat(p):d=-1,p.length&&et())}function et(){if(!f){var t=$(tt);f=!0;for(var e=p.length;e;){for(l=p,p=[];++d<e;)l&&l[d].run();d=-1,e=p.length}l=null,f=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===K||!s)&&clearTimeout)return(s=clearTimeout)(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(t)}}function nt(t,e){this.fun=t,this.array=e}function v(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];p.push(new nt(t,e)),1!==p.length||f||$(et)},nt.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=v,n.addListener=v,n.once=v,n.off=v,n.removeListener=v,n.removeAllListeners=v,n.emit=v,n.prependListener=v,n.prependOnceListener=v,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0};function it(t,e){if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){var n,i,r,o=rt(t),s=rt(e);if(o&&s){if((i=t.length)!=e.length)return!1;for(n=i;0!=n--;)if(!it(t[n],e[n]))return!1;return!0}if(o!=s)return!1;o=t instanceof Date,s=e instanceof Date;if(o!=s)return!1;if(o&&s)return t.getTime()==e.getTime();o=t instanceof RegExp,s=e instanceof RegExp;if(o!=s)return!1;if(o&&s)return t.toString()==e.toString();var c=ot(t);if((i=c.length)!==ot(e).length)return!1;for(n=i;0!=n--;)if(!st.call(e,c[n]))return!1;for(n=i;0!=n--;)if(!it(t[r=c[n]],e[r]))return!1;return!0}return t!=t&&e!=e}var g={},rt=(!function(i){!function(){g.doNothing=function(){},g.hasKeys=function(t){for(var e in t)return!0;return!1},g.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},g.isValidVersion=function(t){return null===t||g.isInteger(t)&&0<=t},g.isValidTimestamp=function(t){return g.isValidVersion(t)},g.MAX_SAFE_INTEGER=9007199254740991,g.dig=function(){for(var t=arguments[0],e=1;e<arguments.length;e++)t=t[arguments[e]]||(e===arguments.length-1?void 0:{});return t},g.digOrCreate=function(){for(var t=arguments[0],e=arguments[arguments.length-1],n=1;n<arguments.length-1;n++)var i=arguments[n],t=t[i]||(t[i]=n===arguments.length-2?e():{});return t},g.digAndRemove=function(){for(var t=arguments[0],e=[t],n=1;n<arguments.length-1;n++){var i=arguments[n];if(!t.hasOwnProperty(i))break;t=t[i],e.push(t)}for(n=e.length-1;0<=n;n--){var r=e[n],o=r[i=arguments[n+1]];n!==e.length-1&&g.hasKeys(o)||delete r[i]}},g.supportsPresence=function(t){return t&&"function"==typeof t.transformPresence},g.callEach=function(t,e){var n=!1;return t.forEach(function(t){t&&(t(e),n=!0)}),n},g.truthy=function(t){return!!t},g.nextTick=function(t){if(void 0!==i&&i.nextTick)return i.nextTick.apply(null,arguments);for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];setTimeout(function(){t.apply(null,e)})}}.call(this)}.call(this,h),Array.isArray),ot=Object.keys,st=Object.prototype.hasOwnProperty,ct={},E=_.CODES;function m(t,e,n){c.EventEmitter.call(this),this.connection=t,this.collection=e,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=null,this.pendingFetch=[],this.pendingSubscribe=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1,this.submitSource=!1,this.paused=!1}function at(t,e){if(t.del)return delete(n=e).op,delete n.create,void delete n.del;var n,i,r;if(e.del)return new _(E.ERR_DOC_WAS_DELETED,"Document was deleted");if(e.create)return new _(E.ERR_DOC_ALREADY_CREATED,"Document already created");if("op"in e){if(t.create)return new _(E.ERR_DOC_ALREADY_CREATED,"Document already created");t.type.transformX?(n=t.type.transformX(t.op,e.op),t.op=n[0],e.op=n[1]):(i=t.type.transform(t.op,e.op,"left"),r=t.type.transform(e.op,t.op,"right"),t.op=i,e.op=r)}}ct=m,c.mixin(m),m.prototype.destroy=function(e){var n=this;n.whenNothingPending(function(){n.wantSubscribe?n.unsubscribe(function(t){if(t)return e?e(t):n.emit("error",t);n.connection._destroyDoc(n),n.emit("destroy"),e&&e()}):(n.connection._destroyDoc(n),n.emit("destroy"),e&&e())})},m.prototype._setType=function(t){if(t="string"==typeof t?y.map[t]:t)this.type=t;else{var e;if(null!==t)return e=new _(E.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+t),this.emit("error",e);this.type=t,this.data=void 0}},m.prototype.ingestSnapshot=function(t,e){if(!t)return e&&e();if("number"!=typeof t.v)return n=new _(E.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id),e?e(n):this.emit("error",n);if(this.type||this.hasWritePending())return null==this.version?this.hasWritePending()?e&&this.once("no write pending",e):(n=new _(E.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id),e?e(n):this.emit("error",n)):t.v>this.version?this.fetch(e):e&&e();if(this.version>t.v)return e&&e();this.version=t.v;var n=void 0===t.type?y.defaultType:t.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(t.data):t.data,this.emit("load"),e&&e()},m.prototype.whenNothingPending=function(t){var e=this;g.nextTick(function(){e.hasPending()?e.once("nothing pending",t):t()})},m.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe||this.pendingFetch.length||this.pendingSubscribe.length)},m.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},m.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},m.prototype._emitResponseError=function(t,e){return t&&t.code===E.ERR_SNAPSHOT_READ_SILENT_REJECTION?(this.wantSubscribe=!1,e&&e(),void this._emitNothingPending()):e?(e(t),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",t))},m.prototype._handleFetch=function(t,e){var n=this.pendingFetch,i=(this.pendingFetch=[],this.inflightFetch.shift());if(i&&n.push(i),n.length&&(i=function(t){g.callEach(n,t)}),t)return this._emitResponseError(t,i);this.ingestSnapshot(e,i),this._emitNothingPending()},m.prototype._handleSubscribe=function(t,e){var n=this.inflightSubscribe;this.inflightSubscribe=null;var i,r=this.pendingFetch;if(this.pendingFetch=[],n.callback&&r.push(n.callback),r.length&&(i=function(t){g.callEach(r,t)}),t)return this._emitResponseError(t,i);this.subscribed=n.wantSubscribe,this.subscribed?this.ingestSnapshot(e,i):i&&i(),this._emitNothingPending(),this._flushSubscribe()},m.prototype._handleOp=function(t,e){if(t)return this.inflightOp?(t.code===E.ERR_OP_SUBMIT_REJECTED&&(t=null),this._rollback(t)):this.emit("error",t);if(this.inflightOp&&e.src===this.inflightOp.src&&e.seq===this.inflightOp.seq)this._opAcknowledged(e);else if(null==this.version||e.v>this.version)this.fetch();else if(!(e.v<this.version)){if(this.inflightOp&&(n=at(this.inflightOp,e)))return this._hardRollback(n);for(var n,i=0;i<this.pendingOps.length;i++)if(n=at(this.pendingOps[i],e))return this._hardRollback(n);this.version++;try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}}},m.prototype._onConnectionStateChanged=function(){this.connection.canSend?(this.flush(),this._resubscribe()):(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,this.inflightSubscribe&&(this.inflightSubscribe.wantSubscribe?(this.pendingSubscribe.unshift(this.inflightSubscribe),this.inflightSubscribe=null):this._handleSubscribe()),this.inflightFetch.length&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch),this.inflightFetch.length=0))},m.prototype._resubscribe=function(){if(!this.pendingSubscribe.length&&this.wantSubscribe)return this.subscribe();!this.pendingSubscribe.some(function(t){return t.wantSubscribe})&&this.pendingFetch.length&&this.fetch(),this._flushSubscribe()},m.prototype.fetch=function(t){var e,n,i,r;this.connection.canSend?(e=this.connection.sendFetch(this),n=this.inflightFetch,i=t,e?(r=n.pop(),n.push(function(t){r&&r(t),i&&i(t)})):n.push(i)):this.pendingFetch.push(t)},m.prototype.subscribe=function(t){this._queueSubscribe(!0,t)},m.prototype.unsubscribe=function(t){this._queueSubscribe(!1,t)},m.prototype._queueSubscribe=function(t,e){var n,i=this.pendingSubscribe[this.pendingSubscribe.length-1]||this.inflightSubscribe;i&&i.wantSubscribe===t?i.callback=(n=(n=[i.callback,e]).filter(g.truthy)).length?function(t){g.callEach(n,t)}:null:(this.pendingSubscribe.push({wantSubscribe:!!t,callback:e}),this._flushSubscribe())},m.prototype._flushSubscribe=function(){if(!this.inflightSubscribe&&this.pendingSubscribe.length){if(this.connection.canSend)return this.inflightSubscribe=this.pendingSubscribe.shift(),this.wantSubscribe=this.inflightSubscribe.wantSubscribe,void(this.wantSubscribe?this.connection.sendSubscribe(this):(this.subscribed=!1,this.connection.sendUnsubscribe(this)));var t;this.pendingSubscribe[0].wantSubscribe||(this.inflightSubscribe=this.pendingSubscribe.shift(),t=this,g.nextTick(function(){t._handleSubscribe()}))}},m.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},m.prototype._otApply=function(t,e){if("op"in t){if(!this.type)throw new _(E.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(this.emit("before op batch",t.op,e),!e&&this.type===y.defaultType&&1<t.op.length){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<t.op.length;i++){for(var r={op:[t.op[i]]},o=n;o<this.applyStack.length;o++){var s=at(this.applyStack[o],r);if(s)return this._hardRollback(s)}this.emit("before op",r.op,e,t.src),this.data=this.type.apply(this.data,r.op),this.emit("op",r.op,e,t.src)}return this.emit("op batch",t.op,e),void this._popApplyStack(n)}return this.emit("before op",t.op,e,t.src),this.data=this.type.apply(this.data,t.op),this.emit("op",t.op,e,t.src),void this.emit("op batch",t.op,e)}if(t.create)return this._setType(t.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(t.create.data):this.type.deserialize(this.type.create(t.create.data)):this.type.create(t.create.data),void this.emit("create",e);var c;t.del&&(c=this.data,this._setType(null),this.emit("del",c,e))},m.prototype._sendOp=function(){if(this.connection.canSend){var t,e=this.connection.id,n=(this.inflightOp||(this.inflightOp=this.pendingOps.shift()),this.inflightOp);if(!n)return t=new _(E.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp"),this.emit("error",t);if(n.sentAt=Date.now(),n.retries=null==n.retries?0:n.retries+1,null==n.seq){if(this.connection.seq>=g.MAX_SAFE_INTEGER)return this.emit("error",new _(E.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));n.seq=this.connection.seq++}this.connection.sendOp(this,n),null==n.src&&(n.src=e)}},m.prototype._submit=function(t,e,n){if(e=e||!0,"op"in t){var i;if(!this.type)return i=new _(E.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id),n?n(i):this.emit("error",i);this.type.normalize&&(t.op=this.type.normalize(t.op))}try{this._pushOp(t,e,n),this._otApply(t,e)}catch(t){return this._hardRollback(t)}var r=this;g.nextTick(function(){r.flush()})},m.prototype._pushOp=function(t,e,n){if(t.source=e,this.applyStack)this.applyStack.push(t);else{e=this._tryCompose(t);if(e)return void e.callbacks.push(n)}t.type=this.type,t.callbacks=[n],this.pendingOps.push(t)},m.prototype._popApplyStack=function(t){if(0<t)this.applyStack.length=t;else{var e=this.applyStack[0];if(this.applyStack=null,e&&-1!==(i=this.pendingOps.indexOf(e)))for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){var e=n[i],r=this._tryCompose(e);r?r.callbacks=r.callbacks.concat(e.callbacks):this.pendingOps.push(e)}}},m.prototype._tryCompose=function(t){if(!this.preventCompose){var e=this.pendingOps[this.pendingOps.length-1];if(e&&!e.sentAt&&(!this.submitSource||it(t.source,e.source)))return e.create&&"op"in t?(e.create.data=this.type.apply(e.create.data,t.op),e):"op"in e&&"op"in t&&this.type.compose?(e.op=this.type.compose(e.op,t.op),e):void 0}},m.prototype.submitOp=function(t,e,n){"function"==typeof e&&(n=e,e=null);e=e&&e.source;this._submit({op:t},e,n)},m.prototype.create=function(t,e,n,i){if("function"==typeof e?(i=e,e=n=null):"function"==typeof n&&(i=n,n=null),e=e||y.defaultType.uri,this.type)return r=new _(E.ERR_DOC_ALREADY_CREATED,"Document already exists"),i?i(r):this.emit("error",r);var r=n&&n.source;this._submit({create:{type:e,data:t}},r,i)},m.prototype.del=function(t,e){if("function"==typeof t&&(e=t,t=null),!this.type)return n=new _(E.ERR_DOC_DOES_NOT_EXIST,"Document does not exist"),e?e(n):this.emit("error",n);var n=t&&t.source;this._submit({del:!0},n,e)},m.prototype.pause=function(){this.paused=!0},m.prototype.resume=function(){this.paused=!1,this.flush()},m.prototype._opAcknowledged=function(t){if(this.inflightOp.create)this.version=t.v;else if(t.v!==this.version)return a.warn("Invalid version from server. Expected: "+this.version+" Received: "+t.v,t),this.fetch();this.version++,this._clearInflightOp()},m.prototype._rollback=function(t){var e=this.inflightOp;if("op"in e&&e.type.invert){e.op=e.type.invert(e.op);for(var n=0;n<this.pendingOps.length;n++){var i=at(this.pendingOps[n],e);if(i)return this._hardRollback(i)}try{this._otApply(e,!1)}catch(t){return this._hardRollback(t)}this._clearInflightOp(t)}else this._hardRollback(t)},m.prototype._hardRollback=function(n){var i=[],r=(this.inflightOp&&i.push(this.inflightOp),i=i.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[],this);this.fetch(function(){for(var t=!!i.length,e=0;e<i.length;e++)t=g.callEach(i[e].callbacks,n)&&t;if(n&&!t)return r.emit("error",n)})},m.prototype._clearInflightOp=function(t){var e=this.inflightOp,e=(this.inflightOp=null,g.callEach(e.callbacks,t));if(this.flush(),this._emitNothingPending(),t&&!e)return this.emit("error",t)};var ut={};function b(t,e,n,i,r,o,s){c.EventEmitter.call(this),this.action=t,this.connection=e,this.id=n,this.collection=i,this.query=r,this.results=null,o&&o.results&&(this.results=o.results,delete o.results),this.extra=void 0,this.options=o,this.callback=s,this.ready=!1,this.sent=!1}ut=b,c.mixin(b),b.prototype.hasPending=function(){return!this.ready},b.prototype.send=function(){if(this.connection.canSend){var t={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(t.o=this.options),this.results){for(var e=[],n=0;n<this.results.length;n++){var i=this.results[n];e.push([i.id,i.version])}t.r=e}this.connection.send(t),this.sent=!0}},b.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&g.nextTick(t)},b.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},b.prototype._handleFetch=function(t,e,n){this.connection._destroyQuery(this),this._handleResponse(t,e,n)},b.prototype._handleSubscribe=function(t,e,n){this._handleResponse(t,e,n)},b.prototype._handleResponse=function(t,e,n){var i=this.callback;if(this.callback=null,t)return this._finishResponse(t,i);if(!e)return this._finishResponse(null,i);function r(t){if(t)return o._finishResponse(t,i);--s||o._finishResponse(null,i)}var o=this,s=1;if(Array.isArray(e))s+=e.length,this.results=this._ingestSnapshots(e,r),this.extra=n;else for(var c in e){s++;var a=e[c];this.connection.get(a.c||this.collection,c).ingestSnapshot(a,r)}r()},b.prototype._ingestSnapshots=function(t,e){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=this.connection.get(r.c||this.collection,r.d);o.ingestSnapshot(r,e),n.push(o)}return n},b.prototype._finishResponse=function(t,e){if(this.emit("ready"),this.ready=!0,t)return this.connection._destroyQuery(this),e?e(t):this.emit("error",t);e&&e(null,this.results,this.extra)},b.prototype._handleError=function(t){this.emit("error",t)},b.prototype._handleDiff=function(t){for(var e,n=0;n<t.length;n++)"insert"===(e=t[n]).type&&(e.values=this._ingestSnapshots(e.values));for(n=0;n<t.length;n++)switch((e=t[n]).type){case"insert":var i=e.values;Array.prototype.splice.apply(this.results,[e.index,0].concat(i)),this.emit("insert",i,e.index);break;case"remove":var r=e.howMany||1,i=this.results.splice(e.index,r);this.emit("remove",i,e.index);break;case"move":var r=e.howMany||1,o=this.results.splice(e.from,r);Array.prototype.splice.apply(this.results,[e.to,0].concat(o)),this.emit("move",o,e.from,e.to)}this.emit("changed",this.results)},b.prototype._handleExtra=function(t){this.extra=t,this.emit("extra",t)};var O={};function R(t,e){if(c.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("LocalPresence presenceId must be a string");this.presence=t,this.presenceId=e,this.connection=t.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}O=R,c.mixin(R),R.prototype.submit=function(t,e){this.value=t,this.send(e)},R.prototype.send=function(t){var e=this._message();this._pendingMessages.push(e),this._callbacksByPresenceVersion[e.pv]=t,this._sendPending()},R.prototype.destroy=function(e){var n=this;this.submit(null,function(t){if(t)return n._callbackOrEmit(t,e);delete n.presence.localPresences[n.presenceId],e&&e()})},R.prototype._sendPending=function(){var e;this.connection.canSend&&((e=this)._pendingMessages.forEach(function(t){e.connection.send(t)}),this._pendingMessages=[])},R.prototype._ack=function(t,e){e=this._getCallback(e);this._callbackOrEmit(t,e)},R.prototype._message=function(){return{a:"p",ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}},R.prototype._getCallback=function(t){var e=this._callbacksByPresenceVersion[t];return delete this._callbacksByPresenceVersion[t],e},R.prototype._callbackOrEmit=function(t,e){if(e)return g.nextTick(e,t);t&&this.emit("error",t)};var S={};function ht(t,e){this.presence=t,this.presenceId=e,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}(S=ht).prototype.receiveUpdate=function(t){t.pv<this.presenceVersion||(this.value=t.p,this.presenceVersion=t.pv,this.presence._updateRemotePresence(this))},ht.prototype.destroy=function(t){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],t&&g.nextTick(t)};var lt,vn={exports:{}},pt=(function(dn,_n,yn){!function(){var t,e;t=this,e=function(t){"use strict";function _(t,e){e|=0;for(var n=Math.max(t.length-e,0),i=Array(n),r=0;r<n;r++)i[r]=t[e+r];return i}function x(e){var n=_(arguments,1);return function(){var t=_(arguments);return e.apply(null,n.concat(t))}}function a(n){return function(){var t=_(arguments),e=t.pop();n.call(this,t,e)}}function j(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var F="function"==typeof yn&&yn,e="object"==typeof dn&&"function"==typeof dn.nextTick;function q(t){setTimeout(t,0)}function B(n){return function(t){var e=_(arguments,1);n(function(){t.apply(null,e)})}}var p=B(F?yn:e?dn.nextTick:q);function n(i){return a(function(t,e){var n;try{n=i.apply(this,t)}catch(t){return e(t)}j(n)&&"function"==typeof n.then?n.then(function(t){H(e,null,t)},function(t){H(e,t.message?t:new Error(t))}):e(null,n)})}function H(t,e,n){try{t(e,n)}catch(t){p(U,t)}}function U(t){throw t}var V="function"==typeof Symbol;function Y(t){return V&&"AsyncFunction"===t[Symbol.toStringTag]}function y(t){return Y(t)?n(t):t}function G(r){return function(e){var t=_(arguments,1),n=a(function(n,t){var i=this;return r(e,function(t,e){y(t).apply(i,n.concat(e))},t)});return t.length?n.apply(this,t):n}}var i="object"==typeof _n&&_n&&_n.Object===Object&&_n,r="object"==typeof self&&self&&self.Object===Object&&self,r=i||r||Function("return this")(),o=r.Symbol,s=Object.prototype,W=s.hasOwnProperty,z=s.toString,c=o?o.toStringTag:void 0,Q=Object.prototype.toString,J="[object Null]",X="[object Undefined]",Z=o?o.toStringTag:void 0;function K(t){{if(null==t)return void 0===t?X:J;if(Z&&Z in Object(t)){var e=t,n=W.call(e,c),i=e[c];try{var r=!(e[c]=void 0)}catch(e){}var o=z.call(e);return r&&(n?e[c]=i:delete e[c]),o}return Q.call(t)}}var $="[object AsyncFunction]",tt="[object Function]",et="[object GeneratorFunction]",nt="[object Proxy]",it=9007199254740991;function rt(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=it}function l(t){return null!=t&&rt(t.length)&&!function(t){if(j(t))return t=K(t),t==tt||t==et||t==$||t==nt}(t)}var ot={};function v(){}function g(e){return function(){var t;null!==e&&(t=e,e=null,t.apply(this,arguments))}}function st(t){return ct&&t[ct]&&t[ct]()}var ct="function"==typeof Symbol&&Symbol.iterator;function at(t){return null!=t&&"object"==typeof t}function ut(t){return at(t)&&"[object Arguments]"==K(t)}var s=Object.prototype,ht=s.hasOwnProperty,lt=s.propertyIsEnumerable,pt=ut(function(){return arguments}())?ut:function(t){return at(t)&&ht.call(t,"callee")&&!lt.call(t,"callee")},E=Array.isArray,s="object"==typeof t&&t&&!t.nodeType&&t,u=s&&vn&&!vn.nodeType&&vn,u=u&&u.exports===s?r.Buffer:void 0,ft=(u?u.isBuffer:void 0)||function(){return!1},dt=/^(?:0|[1-9]\d*)$/;var h={};h["[object Float32Array]"]=h["[object Float64Array]"]=h["[object Int8Array]"]=h["[object Int16Array]"]=h["[object Int32Array]"]=h["[object Uint8Array]"]=h["[object Uint8ClampedArray]"]=h["[object Uint16Array]"]=h["[object Uint32Array]"]=!0,h["[object Arguments]"]=h["[object Array]"]=h["[object ArrayBuffer]"]=h["[object Boolean]"]=h["[object DataView]"]=h["[object Date]"]=h["[object Error]"]=h["[object Function]"]=h["[object Map]"]=h["[object Number]"]=h["[object Object]"]=h["[object RegExp]"]=h["[object Set]"]=h["[object String]"]=h["[object WeakMap]"]=!1;var _t,s="object"==typeof t&&t&&!t.nodeType&&t,f=s&&vn&&!vn.nodeType&&vn,yt=f&&f.exports===s&&i.process,r=function(){try{return f&&f.require&&f.require("util").types||yt&&yt.binding&&yt.binding("util")}catch(t){}}(),u=r&&r.isTypedArray,vt=u?(_t=u,function(t){return _t(t)}):function(t){return at(t)&&rt(t.length)&&!!h[K(t)]},gt=Object.prototype.hasOwnProperty;function Et(t,e){var n,i,r,o,s=E(t),c=!s&&pt(t),a=!s&&!c&&ft(t),u=!s&&!c&&!a&&vt(t),h=s||c||a||u,l=h?function(t,e){for(var n=-1,i=Array(t);++n<t;)i[n]=e(n);return i}(t.length,String):[],p=l.length;for(n in t)!e&&!gt.call(t,n)||h&&("length"==n||a&&("offset"==n||"parent"==n)||u&&("buffer"==n||"byteLength"==n||"byteOffset"==n)||(i=n,r=p,o=void 0,o=typeof i,(r=null==r?9007199254740991:r)&&("number"==o||"symbol"!=o&&dt.test(i))&&-1<i&&i%1==0&&i<r))||l.push(n);return l}var mt,bt,Ot=Object.prototype,Rt=(mt=Object.keys,bt=Object,function(t){return mt(bt(t))}),St=Object.prototype.hasOwnProperty;function Tt(t){return(l(t)?Et:function(t){if(t!==("function"==typeof(e=t&&t.constructor)&&e.prototype||Ot))return Rt(t);var e,n,i=[];for(n in Object(t))St.call(t,n)&&"constructor"!=n&&i.push(n);return i})(t)}function m(e){return function(){if(null===e)throw new Error("Callback was already called.");var t=e;e=null,t.apply(this,arguments)}}function Pt(u){return function(t,e,n){if(n=g(n||v),u<=0||!t)return n(null);var i=function(t){if(l(t))return n=-1,i=(e=t).length,function(){return++n<i?{value:e[n],key:n}:null};var e,n,i,r,o,s,c,a,u,h=st(t);return h?(a=h,u=-1,function(){var t=a.next();return t.done?null:(u++,{value:t.value,key:u})}):(o=Tt(r=t),s=-1,c=o.length,function(){var t=o[++s];return s<c?{value:r[t],key:t}:null})}(t),r=!1,o=0,s=!1;function c(t,e){if(--o,t)r=!0,n(t);else{if(e===ot||r&&o<=0)return r=!0,n(null);s||a()}}function a(){for(s=!0;o<u&&!r;){var t=i();if(null===t)return r=!0,o<=0&&n(null);o+=1,e(t.value,t.key,m(c))}s=!1}a()}}function d(t,e,n,i){Pt(e)(t,y(n),i)}function b(i,r){return function(t,e,n){return i(t,r,e,n)}}function O(t,e,n){(l(t)?function(t,e,n){n=g(n||v);var i=0,r=0,o=t.length;function s(t,e){t?n(t):++r!==o&&e!==ot||n(null)}for(0===o&&n(null);i<o;i++)e(t[i],i,m(s))}:Dt)(t,y(e),n)}var Dt=b(d,1/0);function R(i){return function(t,e,n){return i(O,t,y(e),n)}}function At(t,e,n,i){i=i||v,e=e||[];var r=[],o=0,s=y(n);t(e,function(t,e,n){var i=o++;s(t,function(t,e){r[i]=e,n(t)})},function(t){i(t,r)})}var Nt=R(At),s=G(Nt);function S(r){return function(t,e,n,i){return r(Pt(e),t,y(n),i)}}var T=S(At),i=b(T,1),r=G(i);function wt(t,e){for(var n=-1,i=null==t?0:t.length;++n<i&&!1!==e(t[n],n,t););}var It=function(t,e,n){for(var i=-1,r=Object(t),o=n(t),s=o.length;s--;){var c=o[++i];if(!1===e(r[c],c,r))break}return t};function P(t,e){t&&It(t,e,Tt)}function Ct(t){return t!=t}function kt(t,e,n){if(e==e){for(var i=t,r=e,o=n-1,s=i.length;++o<s;)if(i[o]===r)return o;return-1}for(var c=t,a=Ct,u=c.length,h=n+-1;++h<u;)if(a(c[h],h,c))return h;return-1}function Lt(o,t,s){"function"==typeof t&&(s=t,t=null),s=g(s||v);var e=Tt(o).length;if(!e)return s(null);t=t||e;var c={},a=0,u=!1,h=Object.create(null),i=[],l=[],p={};function f(n,r){i.push(function(){var i,t,e;i=n,u||(t=m(function(t,e){var n;a--,2<arguments.length&&(e=_(arguments,1)),t?(n={},P(c,function(t,e){n[e]=t}),n[i]=e,u=!0,h=Object.create(null),s(t,n)):(c[i]=e,wt(h[i]||[],function(t){t()}),d())}),a++,e=y(r[r.length-1]),1<r.length?e(c,t):e(t))})}function d(){if(0===i.length&&0===a)return s(null,c);for(;i.length&&a<t;)i.shift()()}P(o,function(e,n){if(E(e))return i=e.slice(0,e.length-1),0===(r=i.length)?(f(n,e),void l.push(n)):(p[n]=r,void wt(i,function(t){if(!o[t])throw new Error("async.auto task `"+n+"` has a non-existent dependency `"+t+"` in "+i.join(", "));(h[t]||(h[t]=[])).push(function(){0===--r&&f(n,e)})}));var i,r;f(n,[e]),l.push(n)});for(var n=0;l.length;)n++,wt(function(n){var i=[];return P(o,function(t,e){E(t)&&0<=kt(t,n,0)&&i.push(e)}),i}(l.pop()),function(t){0==--p[t]&&l.push(t)});if(n!==e)throw new Error("async.auto cannot execute tasks due to a recursive dependency");d()}function D(t,e){for(var n=-1,i=null==t?0:t.length,r=Array(i);++n<i;)r[n]=e(t[n],n,t);return r}var Mt="[object Symbol]",xt=1/0,u=o?o.prototype:void 0,jt=u?u.toString:void 0;function Ft(t){if("string"==typeof t)return t;if(E(t))return D(t,Ft)+"";if("symbol"==typeof t||at(t)&&K(t)==Mt)return jt?jt.call(t):"";var e=t+"";return"0"==e&&1/t==-xt?"-0":e}var qt=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]"),o="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",u="\\ud83c[\\udffb-\\udfff]",A="[^\\ud800-\\udfff]",Bt="(?:\\ud83c[\\udde6-\\uddff]){2}",N="[\\ud800-\\udbff][\\udc00-\\udfff]",w="(?:"+o+"|"+u+")?",w="[\\ufe0e\\ufe0f]?"+w+"(?:\\u200d(?:"+[A,Bt,N].join("|")+")[\\ufe0e\\ufe0f]?"+w+")*",A="(?:"+[A+o+"?",o,Bt,N,"[\\ud800-\\udfff]"].join("|")+")",Ht=RegExp(u+"(?="+u+")|"+A+w,"g");function Ut(t){return qt.test(t)?t.match(Ht)||[]:t.split("")}var Vt=/^\s+|\s+$/g;function Yt(t,e,n){if((t=null==t?"":Ft(t))&&(n||void 0===e))return t.replace(Vt,"");if(!t||!(e=Ft(e)))return t;n=Ut(t),t=Ut(e);return function(t,e,n){var i=t.length;if(n=void 0===n?i:n,!e&&i<=n)return t;var r=t,o=e,i=n,s=-1,c=r.length;(i=c<i?c:i)<0&&(i+=c),c=i<(o=o<0?c<-o?0:c+o:o)?0:i-o>>>0,o>>>=0;for(var a=Array(c);++s<c;)a[s]=r[s+o];return a}(n,function(t,e){for(var n=-1,i=t.length;++n<i&&-1<kt(e,t[n],0););return n}(n,t),function(t,e){for(var n=t.length;n--&&-1<kt(e,t[n],0););return n}(n,t)+1).join("")}var Gt=/^(?:async\s+)?(function)?\s*[^\(]*\(\s*([^\)]*)\)/m,Wt=/,/,zt=/(=.+)?(\s*)$/,Qt=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;function Jt(t,e){var s={};P(t,function(i,t){var r,e=Y(i),n=!e&&1===i.length||e&&0===i.length;if(E(i))r=i.slice(0,-1),i=i[i.length-1],s[t]=r.concat(0<r.length?o:i);else if(n)s[t]=i;else{if(r=n=(n=(n=(n=(n=i).toString().replace(Qt,"")).match(Gt)[2].replace(" ",""))?n.split(Wt):[]).map(function(t){return Yt(t.replace(zt,""))}),0===i.length&&!e&&0===r.length)throw new Error("autoInject task functions require explicit parameters.");e||r.pop(),s[t]=r.concat(o)}function o(e,t){var n=D(r,function(t){return e[t]});n.push(t),y(i).apply(null,n)}}),Lt(s,e)}function I(){this.head=this.tail=null,this.length=0}function Xt(t,e){t.length=1,t.head=t.tail=e}function Zt(t,e,n){if(null==e)e=1;else if(0===e)throw new Error("Concurrency must not be zero");var s=y(t),c=0,a=[],u=!1;function i(t,e,n){if(null!=n&&"function"!=typeof n)throw new Error("task callback must be a function");if(l.started=!0,0===(t=E(t)?t:[t]).length&&l.idle())return p(function(){l.drain()});for(var i=0,r=t.length;i<r;i++){var o={data:t[i],callback:n||v};e?l._tasks.unshift(o):l._tasks.push(o)}u||(u=!0,p(function(){u=!1,l.process()}))}var h=!1,l={_tasks:new I,concurrency:e,payload:n,saturated:v,unsaturated:v,buffer:e/4,empty:v,drain:v,error:v,started:!1,paused:!1,push:function(t,e){i(t,!1,e)},kill:function(){l.drain=v,l._tasks.empty()},unshift:function(t,e){i(t,!0,e)},remove:function(t){l._tasks.remove(t)},process:function(){if(!h){for(h=!0;!l.paused&&c<l.concurrency&&l._tasks.length;){var t=[],e=[],n=l._tasks.length;l.payload&&(n=Math.min(n,l.payload));for(var i=0;i<n;i++){var r=l._tasks.shift();t.push(r),a.push(r),e.push(r.data)}c+=1,0===l._tasks.length&&l.empty(),c===l.concurrency&&l.saturated();var o=m(function(o){return function(t){--c;for(var e=0,n=o.length;e<n;e++){var i=o[e],r=kt(a,i,0);0===r?a.shift():0<r&&a.splice(r,1),i.callback.apply(i,arguments),null!=t&&l.error(t,i.data)}c<=l.concurrency-l.buffer&&l.unsaturated(),l.idle()&&l.drain(),l.process()}}(t));s(e,o)}h=!1}},length:function(){return l._tasks.length},running:function(){return c},workersList:function(){return a},idle:function(){return l._tasks.length+c===0},pause:function(){l.paused=!0},resume:function(){!1!==l.paused&&(l.paused=!1,p(l.process))}};return l}function Kt(t,e){return Zt(t,1,e)}I.prototype.removeLink=function(t){return t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,t.prev=t.next=null,--this.length,t},I.prototype.empty=function(){for(;this.head;)this.shift();return this},I.prototype.insertAfter=function(t,e){e.prev=t,e.next=t.next,t.next?t.next.prev=e:this.tail=e,t.next=e,this.length+=1},I.prototype.insertBefore=function(t,e){e.prev=t.prev,(e.next=t).prev?t.prev.next=e:this.head=e,t.prev=e,this.length+=1},I.prototype.unshift=function(t){this.head?this.insertBefore(this.head,t):Xt(this,t)},I.prototype.push=function(t){this.tail?this.insertAfter(this.tail,t):Xt(this,t)},I.prototype.shift=function(){return this.head&&this.removeLink(this.head)},I.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},I.prototype.toArray=function(){for(var t=Array(this.length),e=this.head,n=0;n<this.length;n++)t[n]=e.data,e=e.next;return t},I.prototype.remove=function(t){for(var e=this.head;e;){var n=e.next;t(e)&&this.removeLink(e),e=n}return this};var C=b(d,1);function k(t,i,e,n){n=g(n||v);var r=y(e);C(t,function(t,e,n){r(i,t,function(t,e){i=e,n(t)})},function(t){n(t,i)})}function $t(){var e=D(arguments,y);return function(){var t=_(arguments),i=this,n=t[t.length-1];"function"==typeof n?t.pop():n=v,k(e,t,function(t,e,n){e.apply(i,t.concat(function(t){var e=_(arguments,1);n(t,e)}))},function(t,e){n.apply(i,[t].concat(e))})}}function te(){return $t.apply(null,_(arguments).reverse())}function ee(t,e,n,r){r=r||v;var i=y(n);T(t,e,function(t,e){i(t,function(t){return t?e(t):e(null,_(arguments,1))})},function(t,e){for(var n=[],i=0;i<e.length;i++)e[i]&&(n=ie.apply(n,e[i]));return r(t,n)})}function ne(){var t=_(arguments),e=[null].concat(t);return function(){return arguments[arguments.length-1].apply(this,e)}}var ie=Array.prototype.concat,o=b(ee,1/0),Bt=b(ee,1);function L(t){return t}function M(c,a){return function(t,e,r,n){n=n||v;var o,s=!1;t(e,function(n,t,i){r(n,function(t,e){t?i(t):c(e)&&!o?(o=a(s=!0,n),i(null,ot)):i()})},function(t){t?n(t):n(null,s?o:a(!1))})}}function re(t,e){return e}N=R(M(L,re)),u=S(M(L,re)),A=b(u,1);function oe(n){return function(t){var e=_(arguments,1);e.push(function(t){var e=_(arguments,1);"object"==typeof console&&(t?console.error&&console.error(t):console[n]&&wt(e,function(t){console[n](t)}))}),y(t).apply(null,e)}}w=oe("dir");function se(t,e,n){n=m(n||v);var i=y(t),r=y(e);function o(t){if(t)return n(t);t=_(arguments,1);t.push(s),r.apply(this,t)}function s(t,e){return t?n(t):e?void i(o):n(null)}s(null,!0)}function ce(t,e,n){n=m(n||v);function i(t){return t?n(t):(t=_(arguments,1),e.apply(this,t)?r(i):void n.apply(null,[null].concat(t)))}var r=y(t);r(i)}function ae(t,e,n){ce(t,function(){return!e.apply(this,arguments)},n)}function ue(t,e,n){n=m(n||v);var i=y(e),r=y(t);function o(t){if(t)return n(t);r(s)}function s(t,e){return t?n(t):e?void i(o):n(null)}r(s)}function he(i){return function(t,e,n){return i(t,n)}}function le(t,e,n){O(t,he(y(e)),n)}function pe(t,e,n,i){Pt(e)(t,he(y(n)),i)}var fe=b(pe,1);function de(i){return Y(i)?i:a(function(t,e){var n=!0;t.push(function(){var t=arguments;n?p(function(){e.apply(null,t)}):e.apply(null,t)}),i.apply(this,t),n=!1})}function _e(t){return!t}var ye=R(M(_e,_e)),ve=S(M(_e,_e)),ge=b(ve,1);function Ee(e){return function(t){return null==t?void 0:t[e]}}function me(t,i,e,r){var o=new Array(i.length);t(i,function(t,n,i){e(t,function(t,e){o[n]=!!e,i(t)})},function(t){if(t)return r(t);for(var e=[],n=0;n<i.length;n++)o[n]&&e.push(i[n]);r(null,e)})}function be(t,e,o,n){var s=[];t(e,function(n,i,r){o(n,function(t,e){t?r(t):(e&&s.push({index:i,value:n}),r())})},function(t){t?n(t):n(null,D(s.sort(function(t,e){return t.index-e.index}),Ee("value")))})}function Oe(t,e,n,i){(l(e)?me:be)(t,e,y(n),i||v)}var Re=R(Oe),Se=S(Oe),Te=b(Se,1);function Pe(t,e){var n=m(e||v),i=y(de(t));!function t(e){return e?n(e):void i(t)}()}function De(t,e,n,c){c=c||v;var r=y(n);T(t,e,function(n,i){r(n,function(t,e){return t?i(t):i(null,{key:e,val:n})})},function(t,e){for(var n,i,r={},o=Object.prototype.hasOwnProperty,s=0;s<e.length;s++)e[s]&&(n=e[s].key,i=e[s].val,o.call(r,n)?r[n].push(i):r[n]=[i]);return c(t,r)})}var Ae=b(De,1/0),Ne=b(De,1),we=oe("log");function Ie(t,e,n,i){i=g(i||v);var r={},o=y(n);d(t,e,function(t,n,i){o(t,n,function(t,e){if(t)return i(t);r[n]=e,i()})},function(t){i(t,r)})}var Ce=b(Ie,1/0),ke=b(Ie,1);function Le(t,n){var o=Object.create(null),s=Object.create(null),i=(n=n||L,y(t)),e=a(function(t,e){var r=n.apply(null,t);r in o?p(function(){e.apply(null,o[r])}):r in s?s[r].push(e):(s[r]=[e],i.apply(null,t.concat(function(){var t=_(arguments),e=(o[r]=t,s[r]);delete s[r];for(var n=0,i=e.length;n<i;n++)e[n].apply(null,t)})))});return e.memo=o,e.unmemoized=t,e}e=B(e?dn.nextTick:F?yn:q);function Me(t,e,n){n=n||v;var r=l(e)?[]:{};t(e,function(t,n,i){y(t)(function(t,e){2<arguments.length&&(e=_(arguments,1)),r[n]=e,i(t)})},function(t){n(t,r)})}function xe(t,e){Me(O,t,e)}function je(t,e,n){Me(Pt(e),t,n)}function Fe(t,e){var n=y(t);return Zt(function(t,e){n(t[0],e)},e,1)}function qe(t,e){var c=Fe(t,e);return c.push=function(t,e,n){if("function"!=typeof(n=null==n?v:n))throw new Error("task callback must be a function");if(c.started=!0,0===(t=E(t)?t:[t]).length)return p(function(){c.drain()});e=e||0;for(var i=c._tasks.head;i&&e>=i.priority;)i=i.next;for(var r=0,o=t.length;r<o;r++){var s={data:t[r],priority:e,callback:n};i?c._tasks.insertBefore(i,s):c._tasks.push(s)}p(c.process)},delete c.unshift,c}function Be(t,e){if(e=g(e||v),!E(t))return e(new TypeError("First argument to race must be an array of functions"));if(!t.length)return e();for(var n=0,i=t.length;n<i;n++)y(t[n])(e)}function He(t,e,n,i){k(_(t).reverse(),e,n,i)}function Ue(t){var e=y(t);return a(function(t,n){return t.push(function(t,e){t?n(null,{error:t}):(t=arguments.length<=2?e:_(arguments,1),n(null,{value:t}))}),e.apply(this,t)})}function Ve(t){var n;return E(t)?n=D(t,Ue):(n={},P(t,function(t,e){n[e]=Ue.call(this,t)})),n}function Ye(t,e,i,n){Oe(t,e,function(t,n){i(t,function(t,e){n(t,!e)})},n)}var F=R(Ye),Ge=S(Ye),We=b(Ge,1);function ze(t){return function(){return t}}function Qe(t,e,n){var i={times:5,intervalFunc:ze(0)};if(arguments.length<3&&"function"==typeof t)n=e||v,e=t;else{var r=i;if("object"==typeof t)r.times=+t.times||5,r.intervalFunc="function"==typeof t.interval?t.interval:ze(+t.interval||0),r.errorFilter=t.errorFilter;else{if("number"!=typeof t&&"string"!=typeof t)throw new Error("Invalid arguments for async.retry");r.times=+t||5}n=n||v}if("function"!=typeof e)throw new Error("Invalid arguments for async.retry");var o=y(e),s=1;!function e(){o(function(t){t&&s++<i.times&&("function"!=typeof i.errorFilter||i.errorFilter(t))?setTimeout(e,i.intervalFunc(s)):n.apply(null,arguments)})}()}function Je(i,t){t||(t=i,i=null);var r=y(t);return a(function(e,t){function n(t){r.apply(null,e.concat(t))}i?Qe(i,n,t):Qe(n,t)})}function Xe(t,e){Me(C,t,e)}var Ze=R(M(Boolean,L)),Ke=S(M(Boolean,L)),$e=b(Ke,1);function tn(t,e,n){var r=y(e);function i(t,e){t=t.criteria,e=e.criteria;return t<e?-1:e<t?1:0}Nt(t,function(n,i){r(n,function(t,e){if(t)return i(t);i(null,{value:n,criteria:e})})},function(t,e){if(t)return n(t);n(null,D(e.sort(i),Ee("value")))})}function en(r,o,s){var c=y(r);return a(function(t,e){var n,i=!1;t.push(function(){i||(e.apply(null,arguments),clearTimeout(n))}),n=setTimeout(function(){var t=r.name||"anonymous",t=new Error('Callback function "'+t+'" timed out.');t.code="ETIMEDOUT",s&&(t.info=s),i=!0,e(t)},o),c.apply(null,t)})}var nn=Math.ceil,rn=Math.max;function on(r,t,e,n){e=y(e);T(function(t){for(var e=-1,n=rn(nn(r-t),0),i=Array(n);n--;)i[++e]=t,t+=1;return i}(0),t,e,n)}var sn=b(on,1/0),cn=b(on,1);function an(t,i,e,n){arguments.length<=3&&(n=e,e=i,i=E(t)?[]:{}),n=g(n||v);var r=y(e);O(t,function(t,e,n){r(i,t,e,n)},function(t){n(t,i)})}function un(t,e){var i,r=null;e=e||v,fe(t,function(t,n){y(t)(function(t,e){i=2<arguments.length?_(arguments,1):e,n(!(r=t))})},function(){e(r,i)})}function hn(t){return function(){return(t.unmemoized||t).apply(null,arguments)}}function ln(e,t,n){n=m(n||v);var i=y(t);if(!e())return n(null);function r(t){return t?n(t):e()?i(r):(t=_(arguments,1),void n.apply(null,[null].concat(t)))}i(r)}function pn(t,e,n){ln(function(){return!t.apply(this,arguments)},e,n)}function fn(n,e){if(e=g(e||v),!E(n))return e(new Error("First argument to waterfall must be an array of functions"));if(!n.length)return e();var i=0;function r(t){var e=y(n[i++]);t.push(m(o)),e.apply(null,t)}function o(t){if(t||i===n.length)return e.apply(null,arguments);r(_(arguments,1))}r([])}t.default={apply:x,applyEach:s,applyEachSeries:r,asyncify:n,auto:Lt,autoInject:Jt,cargo:Kt,compose:te,concat:o,concatLimit:ee,concatSeries:Bt,constant:ne,detect:N,detectLimit:u,detectSeries:A,dir:w,doDuring:se,doUntil:ae,doWhilst:ce,during:ue,each:le,eachLimit:pe,eachOf:O,eachOfLimit:d,eachOfSeries:C,eachSeries:fe,ensureAsync:de,every:ye,everyLimit:ve,everySeries:ge,filter:Re,filterLimit:Se,filterSeries:Te,forever:Pe,groupBy:Ae,groupByLimit:De,groupBySeries:Ne,log:we,map:Nt,mapLimit:T,mapSeries:i,mapValues:Ce,mapValuesLimit:Ie,mapValuesSeries:ke,memoize:Le,nextTick:e,parallel:xe,parallelLimit:je,priorityQueue:qe,queue:Fe,race:Be,reduce:k,reduceRight:He,reflect:Ue,reflectAll:Ve,reject:F,rejectLimit:Ge,rejectSeries:We,retry:Qe,retryable:Je,seq:$t,series:Xe,setImmediate:p,some:Ze,someLimit:Ke,someSeries:$e,sortBy:tn,timeout:en,times:sn,timesLimit:on,timesSeries:cn,transform:an,tryEach:un,unmemoize:hn,until:pn,waterfall:fn,whilst:ln,all:ye,allLimit:ve,allSeries:ge,any:Ze,anyLimit:Ke,anySeries:$e,find:N,findLimit:u,findSeries:A,forEach:le,forEachSeries:fe,forEachLimit:pe,forEachOf:O,forEachOfSeries:C,forEachOfLimit:d,inject:k,foldl:k,foldr:He,select:Re,selectLimit:Se,selectSeries:Te,wrapSync:n},t.apply=x,t.applyEach=s,t.applyEachSeries=r,t.asyncify=n,t.auto=Lt,t.autoInject=Jt,t.cargo=Kt,t.compose=te,t.concat=o,t.concatLimit=ee,t.concatSeries=Bt,t.constant=ne,t.detect=N,t.detectLimit=u,t.detectSeries=A,t.dir=w,t.doDuring=se,t.doUntil=ae,t.doWhilst=ce,t.during=ue,t.each=le,t.eachLimit=pe,t.eachOf=O,t.eachOfLimit=d,t.eachOfSeries=C,t.eachSeries=fe,t.ensureAsync=de,t.every=ye,t.everyLimit=ve,t.everySeries=ge,t.filter=Re,t.filterLimit=Se,t.filterSeries=Te,t.forever=Pe,t.groupBy=Ae,t.groupByLimit=De,t.groupBySeries=Ne,t.log=we,t.map=Nt,t.mapLimit=T,t.mapSeries=i,t.mapValues=Ce,t.mapValuesLimit=Ie,t.mapValuesSeries=ke,t.memoize=Le,t.nextTick=e,t.parallel=xe,t.parallelLimit=je,t.priorityQueue=qe,t.queue=Fe,t.race=Be,t.reduce=k,t.reduceRight=He,t.reflect=Ue,t.reflectAll=Ve,t.reject=F,t.rejectLimit=Ge,t.rejectSeries=We,t.retry=Qe,t.retryable=Je,t.seq=$t,t.series=Xe,t.setImmediate=p,t.some=Ze,t.someLimit=Ke,t.someSeries=$e,t.sortBy=tn,t.timeout=en,t.times=sn,t.timesLimit=on,t.timesSeries=cn,t.transform=an,t.tryEach=un,t.unmemoize=hn,t.until=pn,t.waterfall=fn,t.whilst=ln,t.all=ye,t.allLimit=ve,t.allSeries=ge,t.any=Ze,t.anyLimit=Ke,t.anySeries=$e,t.find=N,t.findLimit=u,t.findSeries=A,t.forEach=le,t.forEachSeries=fe,t.forEachLimit=pe,t.forEachOf=O,t.forEachOfSeries=C,t.forEachOfLimit=d,t.inject=k,t.foldl=k,t.foldr=He,t.select=Re,t.selectLimit=Se,t.selectSeries=Te,t.wrapSync=n,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof vn.exports?e(vn.exports):e(t.async=t.async||{})}.call(this)}.call(this,h,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},x({}).setImmediate),vn=vn.exports,lt=function(t,e){if(e=e||16,(t=void 0===t?128:t)<=0)return"0";for(var n=Math.log(Math.pow(2,t))/Math.log(e),i=2;n===1/0;i*=2)n=Math.log(Math.pow(2,t/i))/Math.log(e)*i;for(var r=n-Math.floor(n),o="",i=0;i<Math.floor(n);i++)o=Math.floor(Math.random()*e).toString(e)+o;r&&(r=Math.pow(e,r),o=Math.floor(Math.random()*r).toString(e)+o);r=parseInt(o,e);return r!==1/0&&r>=Math.pow(2,t)?pt(t,e):o}),ft=(pt.rack=function(i,r,o){function n(t){var e=0;do{if(10<e++){if(!o)throw new Error("too many ID collisions, use more bits");i+=o}var n=pt(i,r)}while(Object.hasOwnProperty.call(s,n));return s[n]=t,n}var s=n.hats={};return n.get=function(t){return n.hats[t]},n.set=function(t,e){return n.hats[t]=e,n},n.bits=i||128,n.base=r||16,n},{});function T(t,e){if(c.EventEmitter.call(this),!e||"string"!=typeof e)throw new Error("Presence channel must be provided");this.connection=t,this.channel=e,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={}}ft=T,c.mixin(T),T.prototype.subscribe=function(t){this._sendSubscriptionAction(!0,t)},T.prototype.unsubscribe=function(t){this._sendSubscriptionAction(!1,t)},T.prototype.create=function(t){t=t||lt();var e=this._createLocalPresence(t);return this.localPresences[t]=e},T.prototype.destroy=function(i){var r=this;this.unsubscribe(function(t){if(t)return r._callbackOrEmit(t,i);var e=Object.keys(r.localPresences),n=Object.keys(r._remotePresenceInstances);vn.parallel([function(t){vn.each(e,function(t,e){r.localPresences[t].destroy(e)},t)},function(t){vn.each(n,function(t,e){r._remotePresenceInstances[t].destroy(e)},t)}],function(t){delete r.connection._presences[r.channel],r._callbackOrEmit(t,i)})})},T.prototype._sendSubscriptionAction=function(t,e){this.wantSubscribe=!!t;var t=this.wantSubscribe?"ps":"pu",n=this.connection._presenceSeq++;this._subscriptionCallbacksBySeq[n]=e,this.connection.canSend&&this.connection._sendPresenceAction(t,n,this)},T.prototype._handleSubscribe=function(t,e){this.wantSubscribe&&(this.subscribed=!0);e=this._subscriptionCallback(e);this._callbackOrEmit(t,e)},T.prototype._handleUnsubscribe=function(t,e){this.subscribed=!1;e=this._subscriptionCallback(e);this._callbackOrEmit(t,e)},T.prototype._receiveUpdate=function(t,e){var n=g.dig(this.localPresences,e.id);if(n)return n._ack(t,e.pv);if(t)return this.emit("error",t);var i=this;g.digOrCreate(this._remotePresenceInstances,e.id,function(){return i._createRemotePresence(e.id)}).receiveUpdate(e)},T.prototype._updateRemotePresence=function(t){this.remotePresences[t.presenceId]=t.value,null===t.value&&this._removeRemotePresence(t.presenceId),this.emit("receive",t.presenceId,t.value)},T.prototype._broadcastAllLocalPresence=function(t){if(t)return this.emit("error",t);for(var e in this.localPresences){e=this.localPresences[e];null!==e.value&&e.send()}},T.prototype._removeRemotePresence=function(t){this._remotePresenceInstances[t].destroy(),delete this._remotePresenceInstances[t],delete this.remotePresences[t]},T.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)for(var t in this._resubscribe(),this.localPresences)this.localPresences[t]._sendPending()},T.prototype._resubscribe=function(){var t,e=[];for(t in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(t);e.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(e);var i=this;this.subscribe(function(t){i._callEachOrEmit(e,t)})},T.prototype._subscriptionCallback=function(t){var e=this._subscriptionCallbacksBySeq[t];return delete this._subscriptionCallbacksBySeq[t],e},T.prototype._callbackOrEmit=function(t,e){if(e)return g.nextTick(e,t);t&&this.emit("error",t)},T.prototype._createLocalPresence=function(t){return new O(this,t)},T.prototype._createRemotePresence=function(t){return new S(this,t)},T.prototype._callEachOrEmit=function(t,e){!g.callEach(t,e)&&e&&this.emit("error",e)};var dt={},_t=_.CODES;function P(t,e){O.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._isSending=!1,this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}((dt=P).prototype=Object.create(O.prototype)).submit=function(t,e){if(!this._doc.type){if(null===t)return this._callbackOrEmit(null,e);var n={code:_t.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,e)}O.prototype.submit.call(this,t,e)},P.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createOrDelHandler),this._doc.removeListener("del",this._createOrDelHandler),this._doc.removeListener("load",this._loadHandler),this._doc.removeListener("destroy",this._destroyHandler),O.prototype.destroy.call(this,t)},P.prototype._sendPending=function(){var e;this._isSending||(this._isSending=!0,(e=this)._doc.whenNothingPending(function(){e._isSending=!1,e.connection.canSend&&(e._pendingMessages.forEach(function(t){t.t=e._doc.type.uri,t.v=e._doc.version,e.connection.send(t)}),e._pendingMessages=[])}))},P.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createOrDelHandler),this._doc.on("del",this._createOrDelHandler),this._doc.on("load",this._loadHandler),this._doc.on("destroy",this._destroyHandler)},P.prototype._transformAgainstOp=function(t,n){var i=this;this._pendingMessages.forEach(function(e){try{e.p=i._transformPresence(e.p,t,n)}catch(t){e=i._getCallback(e.pv);i._callbackOrEmit(t,e)}});try{this.value=this._transformPresence(this.value,t,n)}catch(t){this.emit("error",t)}},P.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(t){t.p=null}),this.value=null},P.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[]},P.prototype._message=function(){var t=O.prototype._message.call(this);return t.c=this.collection,t.d=this.id,t.v=null,t.t=null,t},P.prototype._transformPresence=function(t,e,n){var i=this._doc.type;if(g.supportsPresence(i))return i.transformPresence(t,e,n);throw new _(_t.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,"Type does not support presence: "+i.name)};var D={},A=_.CODES;D.checkOp=function(t){if(null==t||"object"!=typeof t)return new _(A.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(null!=t.create){if("object"!=typeof t.create)return new _(A.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var e=t.create.type;if("string"!=typeof e)return new _(A.ERR_OT_OP_BADLY_FORMED,"Missing create type");e=y.map[e];if(null==e||"object"!=typeof e)return new _(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(null!=t.del){if(!0!==t.del)return new _(A.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(!("op"in t))return new _(A.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");return null!=t.src&&"string"!=typeof t.src?new _(A.ERR_OT_OP_BADLY_FORMED,"src must be a string"):null!=t.seq&&"number"!=typeof t.seq?new _(A.ERR_OT_OP_BADLY_FORMED,"seq must be a number"):null==t.src&&null!=t.seq||null!=t.src&&null==t.seq?new _(A.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together"):null!=t.m&&"object"!=typeof t.m?new _(A.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null"):void 0},D.normalizeType=function(t){return y.map[t]&&y.map[t].uri},D.apply=function(t,e){if("object"!=typeof t)return new _(A.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(null!=t.v&&null!=e.v&&t.v!==e.v)return new _(A.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(e.create){if(t.type)return new _(A.ERR_DOC_ALREADY_CREATED,"Document already exists");var n=e.create,i=y.map[n.type];if(!i)return new _(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=i.create(n.data),t.type=i.uri,t.v++}catch(r){return r}}else if(e.del)t.data=void 0,t.type=null,t.v++;else if("op"in e){var r=function(t,e){if(!t.type)return new _(A.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(void 0===e)return new _(A.ERR_OT_OP_NOT_PROVIDED,"Missing op");var n=y.map[t.type];if(!n)return new _(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.data=n.apply(t.data,e)}catch(t){return new _(A.ERR_OT_OP_NOT_APPLIED,t.message)}}(t,e.op);if(r)return r;t.v++}else t.v++},D.transform=function(t,e,n){if(null!=e.v&&e.v!==n.v)return new _(A.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(n.del){if(e.create||"op"in e)return new _(A.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(n.create&&("op"in e||e.create||e.del)||"op"in n&&e.create)return new _(A.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if("op"in n&&"op"in e){if(!t)return new _(A.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if("string"==typeof t&&!(t=y.map[t]))return new _(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.op=t.transform(e.op,n.op,"left")}catch(t){return t}}}null!=e.v&&e.v++},D.applyOps=function(t,e,n){n=n||{};for(var i=0;i<e.length;i++){var r=e[i];if(n._normalizeLegacyJson0Ops)try{f=p=l=h=u=a=c=s=o=void 0;var o=t,s=r;if(o.type===y.defaultType.uri){var c=s.op;if(c)for(var a=0;a<c.length;a++){var u=c[a];"string"==typeof u.lm&&(u.lm=+u.lm);for(var h=u.p,l=o.data,p=0;p<h.length;p++){var f=h[p];"[object Array]"==Object.prototype.toString.call(l)?h[p]=+f:l.constructor===Object&&(h[p]=f.toString()),l=l[f]}}}}catch(d){return new _(A.ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED,"Cannot normalize legacy json0 op")}t.v=r.v;var d=D.apply(t,r);if(d)return d}},D.transformPresence=function(t,e,n){var i=this.checkOp(e);if(i)return i;i=t.t;if(!(i="string"==typeof i?y.map[i]:i))return{code:A.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!g.supportsPresence(i))return{code:A.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(e.create||e.del)return t.p=null,void t.v++;try{t.p=null===t.p?null:i.transformPresence(t.p,e.op,n)}catch(t){return{code:A.ERR_PRESENCE_TRANSFORM_FAILED,message:t.message||t}}t.v++};var yt={};function N(t,e){S.call(this,t,e),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}((yt=N).prototype=Object.create(S.prototype)).receiveUpdate=function(t){this._pending&&t.pv<this._pending.pv||(this.src=t.src,this._pending=t,this._setPendingPresence())},N.prototype.destroy=function(t){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createDelHandler),this._doc.removeListener("del",this._createDelHandler),this._doc.removeListener("load",this._loadHandler),S.prototype.destroy.call(this,t)},N.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createDelHandler),this._doc.on("del",this._createDelHandler),this._doc.on("load",this._loadHandler)},N.prototype._setPendingPresence=function(){var t;this._pendingSetPending||(this._pendingSetPending=!0,(t=this)._doc.whenNothingPending(function(){if(t._pendingSetPending=!1,t._pending)return t._pending.pv<t.presenceVersion?t._pending=null:t._pending.v>t._doc.version?t._doc.fetch():void(t._catchUpStalePresence()&&(t.value=t._pending.p,t.presenceVersion=t._pending.pv,t._pending=null,t.presence._updateRemotePresence(t)))}))},N.prototype._handleOp=function(t,e,n){n=n===this.src;this._transformAgainstOp(t,n),this._cacheOp(t,n),this._setPendingPresence()},S.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()},S.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)},N.prototype._transformAgainstOp=function(t,e){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,t,e)}catch(t){return this.presence.emit("error",t)}this.presence._updateRemotePresence(this)}},N.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var t=this._opCache[this._pending.v],e=t.op,t=t.isOwnOp;null===e?(this._pending.p=null,this._pending.v++):D.transformPresence(this._pending,e,t)}var n=this._pending.v>=this._doc.version;return n&&this._stopCachingOps(),n},N.prototype._startCachingOps=function(){this._opCache=[]},N.prototype._stopCachingOps=function(){this._opCache=null},N.prototype._cacheOp=function(t,e){this._opCache&&(this._opCache[this._doc.version-1]={op:t=t?{op:t}:null,isOwnOp:e})};var vt={};function w(t,e,n){var i=w.channel(e,n);ft.call(this,t,i),this.collection=e,this.id=n}(vt=w).prototype=Object.create(ft.prototype),w.channel=function(t,e){return t+"."+e},w.prototype._createLocalPresence=function(t){return new dt(this,t)},w.prototype._createRemotePresence=function(t){return new yt(this,t)};var gt=function(t,e,n,i,r){this.id=t,this.v=e,this.type=n,this.data=i,this.m=r},I={};function C(t,e,n,i,r){if(c.EventEmitter.call(this),"function"!=typeof r)throw new Error("Callback is required for SnapshotRequest");this.requestId=e,this.connection=t,this.id=i,this.collection=n,this.callback=r,this.sent=!1}I=C,c.mixin(C),C.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},C.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},C.prototype._handleResponse=function(t,e){if(this.emit("ready"),t)return this.callback(t);t=e.meta||null,e=new gt(this.id,e.v,e.type,e.data,t);this.callback(null,e)};var Et={};function mt(t,e,n,i,r,o){if(I.call(this,t,e,n,i,o),!g.isValidVersion(r))throw new Error("Snapshot version must be a positive integer or null");this.version=r}((Et=mt).prototype=Object.create(I.prototype))._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}};var bt={};function Ot(t,e,n,i,r,o){if(I.call(this,t,e,n,i,o),!g.isValidTimestamp(r))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=r}((bt=Ot).prototype=Object.create(I.prototype))._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}};var Rt=_.CODES;function St(t){return 0===t.readyState||1===t.readyState?"connecting":"disconnected"}function k(t){c.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._snapshotRequests={},this.seq=1,this._presenceSeq=1,this.id=null,this.agent=null,this.debug=!1,this.state=St(t),this.bindToSocket(t)}function Tt(t,e){var n=new Error(t.message);return n.code=t.code,e&&(n.data=e),n}function Pt(t){return t.hasPending()}function Dt(t){return t.hasWritePending()}c.mixin(t=k),k.prototype.bindToSocket=function(t){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null);var e=St(this.socket=t),i=(this._setState(e),this.canSend=!1,this);t.onmessage=function(t){try{var e="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){return void a.warn("Failed to parse message",t)}i.debug&&a.info("RECV",JSON.stringify(e));var n={data:e};if(i.emit("receive",n),n.data)try{i.handleMessage(n.data)}catch(t){g.nextTick(function(){i.emit("error",t)})}},1===t.readyState&&i._initializeHandshake(),t.onopen=function(){i._setState("connecting"),i._initializeHandshake()},t.onerror=function(t){i.emit("connection error",t)},t.onclose=function(t){"closed"===t||"Closed"===t?i._setState("closed",t):"stopped"===t||"Stopped by server"===t?i._setState("stopped",t):i._setState("disconnected",t)}},k.prototype.handleMessage=function(t){var e,n,i=null;switch(t.error&&(i=Tt(t.error,t),delete t.error),t.a){case"init":return this._handleLegacyInit(t);case"hs":return this._handleHandshake(i,t);case"qf":return void((e=this.queries[t.id])&&e._handleFetch(i,t.data,t.extra));case"qs":return void((e=this.queries[t.id])&&e._handleSubscribe(i,t.data,t.extra));case"qu":return;case"q":return(e=this.queries[t.id])?i?e._handleError(i):(t.diff&&e._handleDiff(t.diff),void(t.hasOwnProperty("extra")&&e._handleExtra(t.extra))):void 0;case"bf":return this._handleBulkMessage(i,t,"_handleFetch");case"bs":case"bu":return this._handleBulkMessage(i,t,"_handleSubscribe");case"nf":case"nt":return this._handleSnapshotFetch(i,t);case"f":return void((n=this.getExisting(t.c,t.d))&&n._handleFetch(i,t.data));case"s":case"u":return void((n=this.getExisting(t.c,t.d))&&n._handleSubscribe(i,t.data));case"op":return void((n=this.getExisting(t.c,t.d))&&n._handleOp(i,t));case"p":return this._handlePresence(i,t);case"ps":return this._handlePresenceSubscribe(i,t);case"pu":return this._handlePresenceUnsubscribe(i,t);case"pr":return this._handlePresenceRequest(i,t);default:a.warn("Ignoring unrecognized message",t)}},k.prototype._handleBulkMessage=function(t,e,n){if(e.data)for(var i in e.data){var r=e.data[i];(s=this.getExisting(e.c,i))&&(t?s[n](t):r.error?s[n](Tt(r.error)):s[n](null,r))}else if(Array.isArray(e.b))for(var o=0;o<e.b.length;o++)i=e.b[o],(s=this.getExisting(e.c,i))&&s[n](t);else if(e.b)for(var i in e.b){var s;(s=this.getExisting(e.c,i))&&s[n](t)}else a.error("Invalid bulk message",e)},k.prototype._reset=function(){this.agent=null},k.prototype._setState=function(t,e){if(this.state!==t){var n,i,r;if("connecting"===t&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===t&&"connecting"!==this.state)return n=new _(Rt.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+t),this.emit("error",n);for(o in this.state=t,this.canSend="connected"===t,"disconnected"!==t&&"stopped"!==t&&"closed"!==t||this._reset(),this.startBulk(),this.queries)this.queries[o]._onConnectionStateChanged();for(i in this.collections){var o,s=this.collections[i];for(o in s)s[o]._onConnectionStateChanged()}for(r in this._presences)this._presences[r]._onConnectionStateChanged();for(o in this._snapshotRequests)this._snapshotRequests[o]._onConnectionStateChanged();this.endBulk(),this.emit(t,e),this.emit("state",t,e)}},k.prototype.startBulk=function(){this.bulk||(this.bulk={})},k.prototype.endBulk=function(){if(this.bulk)for(var t in this.bulk){var e=this.bulk[t];this._sendBulk("f",t,e.f),this._sendBulk("s",t,e.s),this._sendBulk("u",t,e.u)}this.bulk=null},k.prototype._sendBulk=function(t,e,n){if(n){var i,r,o,s=[],c={},a=0;for(r in n){var u=n[r];null==u?s.push(r):(c[r]=u,i=r,a++)}1===s.length?(r=s[0],this.send({a:t,c:e,d:r})):s.length&&this.send({a:"b"+t,c:e,b:s}),1===a?(o=c[i],this.send({a:t,c:e,d:i,v:o})):a&&this.send({a:"b"+t,c:e,b:c})}},k.prototype._sendAction=function(t,e,n){var i;if(this._addDoc(e),this.bulk)return i=(r=(r=this.bulk[e.collection]||(this.bulk[e.collection]={}))[t]||(r[t]={})).hasOwnProperty(e.id),r[e.id]=n,i;var r={a:t,c:e.collection,d:e.id,v:n};this.send(r)},k.prototype.sendFetch=function(t){return this._sendAction("f",t,t.version)},k.prototype.sendSubscribe=function(t){return this._sendAction("s",t,t.version)},k.prototype.sendUnsubscribe=function(t){return this._sendAction("u",t)},k.prototype.sendOp=function(t,e){this._addDoc(t);var n={a:"op",c:t.collection,d:t.id,v:t.version,src:e.src,seq:e.seq,x:{}};"op"in e&&(n.op=e.op),e.create&&(n.create=e.create),e.del&&(n.del=e.del),t.submitSource&&(n.x.source=e.source),this.send(n)},k.prototype.send=function(t){this.debug&&a.info("SEND",JSON.stringify(t)),this.emit("send",t),this.socket.send(JSON.stringify(t))},k.prototype.close=function(){this.socket.close()},k.prototype.getExisting=function(t,e){if(this.collections[t])return this.collections[t][e]},k.prototype.get=function(t,e){var n=this.collections[t]||(this.collections[t]={}),i=n[e];return i||(i=n[e]=new ct(this,t,e),this.emit("doc",i)),i},k.prototype._destroyDoc=function(t){g.digAndRemove(this.collections,t.collection,t.id)},k.prototype._addDoc=function(t){var e=this.collections[t.collection];(e=e||(this.collections[t.collection]={}))[t.id]!==t&&(e[t.id]=t)},k.prototype._createQuery=function(t,e,n,i,r){var o=this.nextQueryId++,t=new ut(t,this,o,e,n,i,r);return(this.queries[o]=t).send(),t},k.prototype._destroyQuery=function(t){delete this.queries[t.id]},k.prototype.createFetchQuery=function(t,e,n,i){return this._createQuery("qf",t,e,n,i)},k.prototype.createSubscribeQuery=function(t,e,n,i){return this._createQuery("qs",t,e,n,i)},k.prototype.hasPending=function(){return!!(this._firstDoc(Pt)||this._firstQuery(Pt)||this._firstSnapshotRequest())},k.prototype.hasWritePending=function(){return!!this._firstDoc(Dt)},k.prototype.whenNothingPending=function(t){var e=this._firstDoc(Pt);e?e.once("nothing pending",this._nothingPendingRetry(t)):(e=this._firstQuery(Pt))?e.once("ready",this._nothingPendingRetry(t)):(e=this._firstSnapshotRequest())?e.once("ready",this._nothingPendingRetry(t)):g.nextTick(t)},k.prototype._nothingPendingRetry=function(t){var e=this;return function(){g.nextTick(function(){e.whenNothingPending(t)})}},k.prototype._firstDoc=function(t){for(var e in this.collections){var n,i=this.collections[e];for(n in i){var r=i[n];if(t(r))return r}}},k.prototype._firstQuery=function(t){for(var e in this.queries){e=this.queries[e];if(t(e))return e}},k.prototype._firstSnapshotRequest=function(){for(var t in this._snapshotRequests)return this._snapshotRequests[t]},k.prototype.fetchSnapshot=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,r=new Et(this,r,t,e,n,i);(this._snapshotRequests[r.requestId]=r).send()},k.prototype.fetchSnapshotByTimestamp=function(t,e,n,i){"function"==typeof n&&(i=n,n=null);var r=this.nextSnapshotRequestId++,r=new bt(this,r,t,e,n,i);(this._snapshotRequests[r.requestId]=r).send()},k.prototype._handleSnapshotFetch=function(t,e){var n=this._snapshotRequests[e.id];n&&(delete this._snapshotRequests[e.id],n._handleResponse(t,e))},k.prototype._handleLegacyInit=function(t){if(t.protocolMinor)return this._initializeHandshake();this._initialize(t)},k.prototype._initializeHandshake=function(){this.send({a:"hs",id:this.id})},k.prototype._handleHandshake=function(t,e){if(t)return this.emit("error",t);this._initialize(e)},k.prototype._initialize=function(t){if("connecting"===this.state)return 1!==t.protocol?this.emit("error",new _(Rt.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+t.protocol)):y.map[t.type]!==y.defaultType?this.emit("error",new _(Rt.ERR_DEFAULT_TYPE_MISMATCH,t.type+" does not match the server default type")):"string"!=typeof t.id?this.emit("error",new _(Rt.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string")):(this.id=t.id,void this._setState("connected"))},k.prototype.getPresence=function(t){var e=this;return g.digOrCreate(this._presences,t,function(){return new ft(e,t)})},k.prototype.getDocPresence=function(t,e){var n=vt.channel(t,e),i=this;return g.digOrCreate(this._presences,n,function(){return new vt(i,t,e)})},k.prototype._sendPresenceAction=function(t,e,n){this._addPresence(n);t={a:t,ch:n.channel,seq:e};return this.send(t),t.seq},k.prototype._addPresence=function(t){g.digOrCreate(this._presences,t.channel,function(){return t})},k.prototype._handlePresenceSubscribe=function(t,e){var n=g.dig(this._presences,e.ch);n&&n._handleSubscribe(t,e.seq)},k.prototype._handlePresenceUnsubscribe=function(t,e){var n=g.dig(this._presences,e.ch);n&&n._handleUnsubscribe(t,e.seq)},k.prototype._handlePresence=function(t,e){var n=g.dig(this._presences,e.ch);n&&n._receiveUpdate(t,e)},k.prototype._handlePresenceRequest=function(t,e){var n=g.dig(this._presences,e.ch);n&&n._broadcastAllLocalPresence(t,e)};var L={},At=(L.Connection=t,L.Doc=ct,L.Error=_,L.Query=ut,L.types=y,L.logger=a,{});return function(){At=L}.call(this),At});
