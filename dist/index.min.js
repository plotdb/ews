!function(){var h,e,t;h=function(t){var n=new Error;return n.name="lderror",n.id=t,n},(e=function(t){var n;return this._scheme=(t=null==t?{}:t).scheme,this._domain=t.domain,this._path=t.path,this._svl=[],t.url&&!t.ws&&(this._url=t.url,(n=/^(\S+):\/\/([^\s\/]+)\/(.+)$/.exec(this._url))&&(this._scheme=n[0],this._domain=n[1],this._path=n[2])),this._scheme=this._scheme||("undefined"!=typeof window&&null!==window&&window.location.protocol?window.location.protocol.replace(":",""):"wss"),this._scheme.startsWith("https")?this._scheme="wss":this._scheme.startsWith("http")&&(this._scheme="ws"),this._domain=this._domain||("undefined"!=typeof window&&null!==window?window.location.host:null),this._path=this._path?"/"!==this._path[0]?"/"+this._path:this._path:"/",this._src=t.src,t.ws&&(t.ws instanceof e?(this._ws=t.ws.ws(),this._src=t.ws._src||t.ws):this._ws=t.ws),this._src&&this._src._supervise(this),this._ws||this._url||(this._url=this._scheme+"://"+this._domain+this._path),!this._ws&&this._url&&(this._origin=!0),this._scope=t.scope||"",this._evthdr={},this._hdr=new WeakMap,this._ctrl={count:0,pending:[],hdr:null,canceller:null,disconnector:null},this._ping={hdr:null,interval:t.pingInterval||60},this._s=0,this}).prototype=((t=Object.create(Object.prototype)).unping=function(){var t;return clearTimeout(this._ping.hdr),document.removeEventListener("visibilitychange",this._ping.check),(t=this._ping).hdr=null,t.running=!1,t},t.ping=function(t){var n=this;if(null==t&&(t={}),this._ping.running||(this._ping.isVisible=function(){return n._ping.visible="visible"===document.visibilityState},this._ping.check=function(){if(n._ping.isVisible())return n.ping({now:!0})},this._ping.running=!0,document.addEventListener("visibilitychange",this._ping.check)),this._ping.hdr&&clearTimeout(this._ping.hdr),this._ping.isVisible)return t.now&&2===this.status()&&this.send("ping"),this._ping.hdr=setTimeout(function(){return n._ping.hdr=null,n.ping({now:!0})},1e3*(20<(t=t.interval||this._ping.interval||60)?t:20))},t.addEventListener=function(t,n,e,s){var i;if("message"===t||"open"===t||"close"===t||"error"===t)return((i=this._evthdr)[t]||(i[t]=[])).push({cb:n,o:e,fromon:s}),this._installEventListener(t,n,e,s)},t._installEventListener=function(t,e,n,s){var i,r=this;if(this._ws)return"message"!==t?this._ws.addEventListener(t,e,n||{}):(this._scope,i=s,r._ws.addEventListener(t,s=function(t){var n;if(t.data.startsWith(r._scope+"|"))return n=t.data.substring(r._scope.length+1),i?e(n):(n=new MessageEvent("message",{data:n,origin:t.origin,ports:t.ports,source:t.source}),e(n))},n||{}),r._hdr.set(e,s))},t._installEventListeners=function(){var t,n,e,s,i,r,o,h,u,c=[];for(t in n=this._evthdr){for(s=[],i=0,r=(e=n[t]).length;i<r;++i)o=(u=e[i]).cb,h=u.o,u=u.fromon,s.push(this._installEventListener(t,o,h,u));c.push(s)}return c},t.dispatchEvent=function(t){return this._ws.dispatchEvent(t)},t.removeEventListener=function(t,n,e){var s;if((s=this._evthdr)[t]||(s[t]=[]),s[t]=this._evthdr[t].filter(function(t){return t.h!==n}),this._ws)return"message"!==t?this._ws.removeEventListener(t,n,e):this._ws.removeEventListener(t,this._hdr.get(n),e)},t.close=function(t,n){if(this._ws)return this._ws.close(t,n)},t.send=function(t){if(this._ws)return this._ws.send(this._scope+"|"+t)},t),Object.defineProperties(e.prototype,{bufferedAmount:{get:function(){return this._ws?this._ws.bufferedAmount:0}},binaryType:{get:function(){return this._ws?this._ws.binaryType:"blob"}},protocol:{get:function(){return this._ws?this._ws.protocol:this._scheme}},readyState:{get:function(){return this._ws?this._ws.readyState:3}},url:{get:function(){return this._ws?this._ws.url:this._url}},onmessage:{set:function(n){return this.addEventListener("message",function(t){return n(t)})}},onopen:{set:function(t){return this.addEventListener("open",t)}},onerror:{set:function(t){return this.addEventListener("error",t)}},onclose:{set:function(t){return this.addEventListener("close",t)}}}),(t=e.prototype).on=function(t,e){var s=this;return"message"===t||"open"===t||"error"===t||"close"===t?this.addEventListener(t,e,null,!0):(Array.isArray(t)?t:[t]).map(function(t){var n;return((n=s._evthdr)[t]||(n[t]=[])).push(e)})},t.fire=function(t){for(var n,e,s,i,r=[],o=[],h=1,u=arguments.length;h<u;++h)o.push(arguments[h]);if(n=o,"message"===t||"open"===t||"close"===t||"error"===t)throw new Error("fire should not be used to fire native events");for(h=0,s=(e=this._evthdr[t]||[]).length;h<s;++h)i=e[h],r.push(i.apply(this,n));return r},t.ws=function(){return this._ws},t.pipe=function(t){return new e({ws:this._ws,scope:this._scope+"/"+(t=null==t?"":t),src:this})},t._supervise=function(t,n){if(null==n&&(n=!0),function(t,n){var e=-1,s=n.length>>>0;for(;++e<s;)if(t===n[e])return 1;return}(t,this._svl)){if(!n)return this._svl.splice(this._svl.indexOf(t),1)}else if(n)return this._svl.push(t)},t._connect=function(t){var s=this;return null==t&&(t={}),new Promise(function(t,n){var e;return s._ws?n(h(1011)):s._url?(s._ws=new WebSocket(s._url),s._svl.map(function(t){return t._ws=s._ws,t._installEventListeners()}),s.closeHandler=function(t){if(this._ws&&this._ws===t)return this._ws=null,this._svl.map(function(t){return t._ws=null}),2!==this._s?n(h(0)):(this._status(0),this.fire("offline"),this._ctrl.disconnector?this._ctrl.disconnector.res():void 0)},window.addEventListener("offline",function(){return s.disconnect()}),(e=s)._ws.addEventListener("close",function(){return e.closeHandler(this)}),s._ws.addEventListener("open",function(){return s._ctrl.canceller?(s._ctrl.canceller.res(),n(h(0))):t()}),s._installEventListeners()):n(h(1026))})},t.connect=function(i){var r,o=this;return null==i&&(i={}),r=this._ctrl,2===this._s?Promise.reject(h(1011)):(i.now&&r.hdr&&(clearTimeout(r.hdr),r.hdr=null,this._status(0)),new Promise(function(t,n){var e,s;if(r.pending.push({res:t,rej:n}),1!==o._s)return o._status(1),e=!(null!=i.retry&&i.retry),r.count=0,(s=function(){var t=Math.round(500*Math.pow(r.count++,1.4))+(i.delay||0);return r.hdr=setTimeout(function(){return r.hdr=null,console.log("reconnect ( "+t+" ms )"),o._connect().then(function(){return o._status(2),(r.pending||(r.pending=[])).splice(0).map(function(t){return t.res()})}).catch(function(t){if(!t||!t.id||1011!==t.id)return e&&!r.canceller?s():(r.canceller=null,(r.pending||(r.pending=[])).splice(0).map(function(t){return t.rej()}))})},t)})()}))},t.disconnect=function(){var t,e=this;return 0===this._s?Promise.resolve():1===this._s?this.cancel():(t=new Promise(function(t,n){return e._ctrl.disconnector={res:t,rej:n}}),this._ws.close(),this.closeHandler(this._ws),t)},t.cancel=function(){var e=this._ctrl;return 1!==this._s?Promise.reject(h(1026)):e.hdr?(clearTimeout(e.hdr),e.hdr=null,this._status(0),Promise.resolve()):new Promise(function(t,n){return e.canceller={res:t,rej:n}})},t._status=function(t){var n=this._s;if((this._s=t)!==n)return this.fire("status",t)},t.status=function(){return this._src?this._src.status():this._s},t.ensure=function(){return 2===this._s?Promise.resolve():this.connect()},"undefined"!=typeof module&&null!==module?module.exports=e:"undefined"!=typeof window&&null!==window&&(window.ews=e)}.call(this);
