!function(){var n,s,t;n=function(t){var e=new Error;return e.name="lderror",e.id=t,e},(s=function(t){var e;return this._scheme=(t=null==t?{}:t).scheme,this._domain=t.domain,this._path=t.path,this._svl=[],t.url&&!t.ws&&(this._url=t.url,(e=/^(\S+):\/\/([^\s\/]+)\/(.+)$/.exec(this._url))&&(this._scheme=e[0],this._domain=e[1],this._path=e[2])),this._scheme=this._scheme||("undefined"!=typeof window&&null!==window&&window.location.protocol?window.location.protocol.replace(":",""):"wss"),this._scheme.startsWith("https")?this._scheme="wss":this._scheme.startsWith("http")&&(this._scheme="ws"),this._domain=this._domain||("undefined"!=typeof window&&null!==window?window.location.host:null),this._path=this._path?"/"!==this._path[0]?"/"+this._path:this._path:"/",this._src=t.src,t.ws&&(t.ws instanceof s?(this._ws=t.ws.ws(),this._src=t.ws._src||t.ws):this._ws=t.ws),this._src&&this._src._supervise(this),this._ws||this._url||(this._url=this._scheme+"://"+this._domain+this._path),!this._ws&&this._url&&(this._origin=!0),this._scope=t.scope||"",this._evthdr={},this._hdr=new WeakMap,this._ctrl={count:0,pending:[],hdr:null,canceller:null,disconnector:null},this._s=0,this}).prototype=((t=Object.create(Object.prototype)).addEventListener=function(t,e,s,n){var r;if("message"===t||"open"===t||"close"===t||"error"===t)return((r=this._evthdr)[t]||(r[t]=[])).push({cb:e,o:s,fromon:n}),this._installEventListener(t,e,s,n)},t._installEventListener=function(t,s,e,n){var r,i=this;if(this._ws)return"message"!==t?this._ws.addEventListener(t,s,e||{}):(this._scope,r=n,i._ws.addEventListener(t,n=function(t){var e;if(t.data.startsWith(i._scope+"|"))return e=t.data.substring(i._scope.length+1),r?s(e):(e=new MessageEvent("message",{data:e,origin:t.origin,ports:t.ports,source:t.source}),s(e))},e||{}),i._hdr.set(s,n))},t._installEventListeners=function(){var t,e,s,n,r,i,o,h,u,c=[];for(t in e=this._evthdr){for(n=[],r=0,i=(s=e[t]).length;r<i;++r)o=(u=s[r]).cb,h=u.o,u=u.fromon,n.push(this._installEventListener(t,o,h,u));c.push(n)}return c},t.dispatchEvent=function(t){return this._ws.dispatchEvent(t)},t.removeEventListener=function(t,e,s){var n;if((n=this._evthdr)[t]||(n[t]=[]),n[t]=this._evthdr[t].filter(function(t){return t.h!==e}),this._ws)return"message"!==t?this._ws.removeEventListener(t,e,s):this._ws.removeEventListener(t,this._hdr.get(e),s)},t.close=function(t,e){return this._ws.close(t,e)},t.send=function(t){return this._ws.send(this._scope+"|"+t)},t),Object.defineProperties(s.prototype,{bufferedAmount:{get:function(){return this._ws?this._ws.bufferedAmount:0}},binaryType:{get:function(){return this._ws?this._ws.binaryType:"blob"}},protocol:{get:function(){return this._ws?this._ws.protocol:this._scheme}},readyState:{get:function(){return this._ws?this._ws.readyState:3}},url:{get:function(){return this._ws?this._ws.url:this._url}},onmessage:{set:function(e){return this.addEventListener("message",function(t){return e(t)})}},onopen:{set:function(t){return this.addEventListener("open",t)}},onerror:{set:function(t){return this.addEventListener("error",t)}},onclose:{set:function(t){return this.addEventListener("close",t)}}}),(t=s.prototype).on=function(t,s){var n=this;return"message"===t||"open"===t||"error"===t||"close"===t?this.addEventListener(t,s,null,!0):(Array.isArray(t)?t:[t]).map(function(t){var e;return((e=n._evthdr)[t]||(e[t]=[])).push(s)})},t.fire=function(t){for(var e,s,n,r,i=[],o=[],h=1,u=arguments.length;h<u;++h)o.push(arguments[h]);if(e=o,"message"===t||"open"===t||"close"===t||"error"===t)throw new Error("fire should not be used to fire native events");for(h=0,n=(s=this._evthdr[t]||[]).length;h<n;++h)r=s[h],i.push(r.apply(this,e));return i},t.ws=function(){return this._ws},t.pipe=function(t){return new s({ws:this._ws,scope:this._scope+"/"+(t=null==t?"":t),src:this})},t._supervise=function(t,e){if(null==e&&(e=!0),function(t,e){var s=-1,n=e.length>>>0;for(;++s<n;)if(t===e[s])return 1;return}(t,this._svl)){if(!e)return this._svl.splice(this._svl.indexOf(t),1)}else if(e)return this._svl.push(t)},t._connect=function(t){var s=this;return null==t&&(t={}),new Promise(function(t,e){return s._ws?e(n(1011)):s._url?(s._ws=new WebSocket(s._url),s._svl.map(function(t){return t._ws=s._ws}),s._ws.addEventListener("close",function(){return s._ws=null,s._svl.map(function(t){return t._ws=null}),2!==s._s?e(n(0)):(s._status(0),s._ctrl.disconnector?s._ctrl.disconnector.res():void 0)}),s._ws.addEventListener("open",function(){return s._ctrl.canceller?(s._ctrl.canceller.res(),e(n(0))):t()}),s._installEventListeners()):e(n(1026))})},t.connect=function(r){var i,o=this;return null==r&&(r={}),i=this._ctrl,2===this._s?Promise.reject(n(1011)):(r.now&&i.hdr&&(clearTimeout(i.hdr),i.hdr=null,this._status(0)),new Promise(function(t,e){var s,n;if(i.pending.push({res:t,rej:e}),1!==o._s)return o._status(1),s=!(null!=r.retry&&r.retry),i.count=0,(n=function(){var t=Math.round(500*Math.pow(i.count++,1.4))+(r.delay||0);return i.hdr=setTimeout(function(){return i.hdr=null,console.log("reconnect ( "+t+" ms )"),o._connect().then(function(){return o._status(2),(i.pending||(i.pending=[])).splice(0).map(function(t){return t.res()})}).catch(function(t){if(!t||!t.id||1011!==t.id)return s&&!i.canceller?n():(i.canceller=null,(i.pending||(i.pending=[])).splice(0).map(function(t){return t.rej()}))})},t)})()}))},t.disconnect=function(){var t,s=this;return 0===this._s?Promise.resolve():1===this._s?this.cancel():(t=new Promise(function(t,e){return s._ctrl.disconnector={res:t,rej:e}}),this._ws.close(),t)},t.cancel=function(){var s=this._ctrl;return 1!==this._s?Promise.reject(n(1026)):s.hdr?(clearTimeout(s.hdr),s.hdr=null,this._status(0),Promise.resolve()):new Promise(function(t,e){return s.canceller={res:t,rej:e}})},t._status=function(t){var e=this._s;if((this._s=t)!==e)return this.fire("status",t)},t.status=function(){return this._s},t.ensure=function(){return 2===this._s?Promise.resolve():this.connect()},"undefined"!=typeof module&&null!==module?module.exports=s:"undefined"!=typeof window&&null!==window&&(window.ews=s)}.call(this);
