!function(){var t,s=function(t){var e=new Error;return e.name="lderror",e.id=t,e},n=function(t){var e;return this._src=(t=null==t?{}:t).src,this._scheme=t.scheme,this._domain=t.domain,this._path=t.path,t.url&&!t.ws&&(this._url=t.url,(e=/^(\S+):\/\/([^\s\/]+)\/(.+)$/.exec(this._url))&&(this._scheme=e[0],this._domain=e[1],this._path=e[2])),this._scheme=this._scheme||("undefined"!=typeof window&&null!==window&&window.location.protocol?window.location.protocol.replace(":",""):"wss"),this._scheme.startsWith("https")?this._scheme="wss":this._scheme.startsWith("http")&&(this._scheme="ws"),this._domain=this._domain||("undefined"!=typeof window&&null!==window?window.location.host:null),this._path=this._path?"/"!==this._path[0]?"/"+this._path:this._path:"/",t.ws&&(this._ws=t.ws instanceof n?t.ws.ws():t.ws),this._ws||this._url||(this._url=this._scheme+"://"+this._domain+this._path),!this._ws&&this._url&&(this._origin=!0),this._scope=t.scope||"",this._evthdr={},this._hdr=new WeakMap,this._ctrl={count:0,pending:[],hdr:null,canceller:null,disconnector:null},this._s=0,this};n.prototype=((t=Object.create(Object.prototype)).addEventListener=function(t,e,n,s){var r;if("message"===t||"open"===t||"close"===t||"error"===t)return((r=this._evthdr)[t]||(r[t]=[])).push({cb:e,o:n,fromon:s}),this._installEventListener(t,e,n,s)},t._installEventListener=function(t,n,e,s){var r,i=this;if(this._ws)return"message"!==t?this._ws.addEventListener(t,n,e||{}):(this._scope,r=s,i._ws.addEventListener(t,s=function(t){var e;if(t.data.startsWith(i._scope+"|"))return e=t.data.substring(i._scope.length+1),r?n(e):(e=new MessageEvent("message",{data:e,origin:t.origin,ports:t.ports,source:t.source}),n(e))},e||{}),i._hdr.set(n,s))},t._installEventListeners=function(){var t,e,n,s,r,i,o,h,u,c=[];for(t in e=this._evthdr){for(s=[],r=0,i=(n=e[t]).length;r<i;++r)o=(u=n[r]).cb,h=u.o,u=u.fromon,s.push(this._installEventListener(t,o,h,u));c.push(s)}return c},t.dispatchEvent=function(t){return this._ws.dispatchEvent(t)},t.removeEventListener=function(t,e,n){var s;if((s=this._evthdr)[t]||(s[t]=[]),s[t]=this._evthdr[t].filter(function(t){return t.h!==e}),this._ws)return"message"!==t?this._ws.removeEventListener(t,e,n):this._ws.removeEventListener(t,this._hdr.get(e),n)},t.close=function(t,e){return this._ws.close(t,e)},t.send=function(t){return this._ws.send(this._scope+"|"+t)},t),Object.defineProperties(n.prototype,{bufferedAmount:{get:function(){return this._ws?this._ws.bufferedAmount:0}},binaryType:{get:function(){return this._ws?this._ws.binaryType:"blob"}},protocol:{get:function(){return this._ws?this._ws.protocol:this._scheme}},readyState:{get:function(){return this._ws?this._ws.readyState:3}},url:{get:function(){return this._ws?this._ws.url:this._url}},onmessage:{set:function(e){return this.addEventListener("message",function(t){return e(t)})}},onopen:{set:function(t){return this.addEventListener("open",t)}},onerror:{set:function(t){return this.addEventListener("error",t)}},onclose:{set:function(t){return this.addEventListener("close",t)}}}),(t=n.prototype).on=function(t,n){var s=this;return"message"===t||"open"===t||"error"===t||"close"===t?this.addEventListener(t,n,null,!0):(Array.isArray(t)?t:[t]).map(function(t){var e;return((e=s._evthdr)[t]||(e[t]=[])).push(n)})},t.fire=function(t){for(var e,n,s,r,i=[],o=[],h=1,u=arguments.length;h<u;++h)o.push(arguments[h]);if(e=o,"message"===t||"open"===t||"close"===t||"error"===t)throw new Error("fire should not be used to fire native events");for(h=0,s=(n=this._evthdr[t]||[]).length;h<s;++h)r=n[h],i.push(r.apply(this,e));return i},t.ws=function(){return this._ws},t.pipe=function(t){return new n({ws:this._ws,scope:this._scope+"/"+(t=null==t?"":t),src:this})},t._connect=function(t){var n=this;return null==t&&(t={}),new Promise(function(t,e){return n._ws?e(s(1011)):n._url?(n._ws=new WebSocket(n._url),n._ws.addEventListener("close",function(){return n._ws=null,2!==n._s?e(s(0)):(n._status(0),n._ctrl.disconnector?n._ctrl.disconnector.res():void 0)}),n._ws.addEventListener("open",function(){return n._ctrl.canceller?(n._ctrl.canceller.res(),e(s(0))):t()}),n._installEventListeners()):e(s(1026))})},t.connect=function(r){var i,o=this;return null==r&&(r={}),i=this._ctrl,2===this._s?Promise.reject(s(1011)):new Promise(function(t,e){var n,s;if(i.pending.push({res:t,rej:e}),1!==o._s)return o._status(1),n=!(null!=r.retry&&r.retry),i.count=0,(s=function(){var t=Math.round(500*Math.pow(i.count++,1.4))+(r.delay||0);return i.hdr=setTimeout(function(){return i.hdr=null,console.log("reconnect ( "+t+" ms )"),o._connect().then(function(){return o._status(2),(i.pending||(i.pending=[])).splice(0).map(function(t){return t.res()})}).catch(function(t){if(!t||!t.id||1011!==t.id)return n&&!i.canceller?s():(i.canceller=null,(i.pending||(i.pending=[])).splice(0).map(function(t){return t.rej()}))})},t)})()})},t.disconnect=function(){var t,n=this;return 0===this._s?Promise.resolve():1===this._s?this.cancel():(t=new Promise(function(t,e){return n._ctrl.disconnector={res:t,rej:e}}),this._ws.close(),t)},t.cancel=function(){var n=this._ctrl;return 1!==this._s?Promise.reject(s(1026)):n.hdr?(clearTimeout(n.hdr),n.hdr=null,this._status(0),Promise.resolve()):new Promise(function(t,e){return n.canceller={res:t,rej:e}})},t._status=function(t){var e=this._s;if((this._s=t)!==e)return this.fire("status",t)},t.status=function(){return this._s},t.ensure=function(){return 2===this._s?Promise.resolve():this.connect()},"undefined"!=typeof module&&null!==module?module.exports=n:"undefined"!=typeof window&&null!==window&&(window.ews=n)}.call(this);
