!function(){var c=require("sharedb"),a=require("@plotdb/sharedb-postgres"),l=require("sharedb-pg-mdb"),d=require("ws"),p=require("http"),m=require("websocket-json-stream"),v=require("./index");module.exports=function(e){var r=e.app,n=e.io,t=e.session,u=e.access,s=e.milestoneDb,e=e.wss,o=null,s=s&&s.enabled?new l({ioPg:n,interval:s.interval||250}):null,i=new c({db:a(n),milestoneDb:s}),n=i.connect();return e||(o=p.createServer(r),e=new d.Server({server:o})),e.on("connection",function(e,n){var r=null!=t?new Promise(function(e,r){return t(n,{},function(){return e()})}):Promise.resolve(),s=new v({ws:e,scope:"sharedb"});return r.then(function(){return i.listen(m(s),n)}).catch(function(e){return console.log("[sdb-server] wss on connection error: ",e.message,e)}),e.on("close",function(){})}),i.use("connect",function(e,r){var n,s=e.agent,t=e.req,e=e.stream;return t&&e.ws&&(n=(e=t.session)&&e.passport&&e.passport.user,(s=s.custom).req=t,s.session=e,s.user=n),r()}),i.use("readSnapshots",function(e,r){var n,s,t=e.collection,o=e.snapshots,e=e.agent;return e.stream.ws?((e=e.custom).req,n=e.session,e=e.user,s=(o[0]||{}).id,(null!=u?u({user:e,session:n,collection:t,id:s,snapshots:o,type:"readSnapshots"}):Promise.resolve()).then(function(){return r()}).catch(function(e){return r(e||((e=new Error).name="lderror",e.id=1012,e))})):r()}),i.use("reply",function(e,r){e.collection;var n=e.agent,e=e.reply;return n.stream.ws&&((n=n.custom).req,n.session,n.user,e.a,e.d),r()}),i.use("receive",function(e,r){e.collection;var n=e.agent,e=e.data;return n.stream.ws&&((n=n.custom).req,n.session,n.user,e.a,e.d),r()}),{server:o,sdb:i,connect:n,wss:e}}}.call(this);
