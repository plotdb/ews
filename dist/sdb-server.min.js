!function(){var a,l,m,d,p,f,h,w;function v(e,n){var r,s={}.hasOwnProperty;for(r in n)s.call(n,r)&&(e[r]=n[r]);return e}a=require("sharedb"),l=require("@plotdb/sharedb-postgres"),m=require("sharedb-pg-mdb"),d=require("ws"),p=require("http"),f=require("websocket-json-stream"),h=require("./index"),w=function(e){return"lderror"!==(e=e||{name:"lderror",id:1012}).name?e:{code:"wrapped-lderror",message:JSON.stringify({id:e.id,name:e.name,message:e.message})}},module.exports=function(e){var n=e.app,r=e.io,t=e.session,o=e.access,s=e.milestoneDb,u=e.wss,i=e.metadata,e=null,s=s&&s.enabled?new m({ioPg:r,interval:s.interval||250}):null,c=new a({db:l(r),milestoneDb:s}),r=c.connect();return u||(e=p.createServer(n),u=new d.Server({server:e})),u.on("connection",function(e,r){var n=null!=t?new Promise(function(e,n){return t(r,{},function(){return e()})}):Promise.resolve(),s=new h({ws:e,scope:"sharedb"});return n.then(function(){return c.listen(f(s),r)}).catch(function(e){return console.log("[sdb-server] wss on connection error: ",e.message,e)}),e.on("close",function(){})}),c.use("connect",function(e,n){var r,s=e.agent,t=e.req,e=e.stream;return t&&e.ws&&(r=(e=t.session)&&e.passport&&e.passport.user||{},(s=s.custom).req=t,s.session=e,s.user=r),n()}),null!=i&&c.use("commit",function(e,n){e.collection;var r=e.agent,s=(e.snapshot,e.op);e.id;return r.stream.ws&&((e=r.custom).req,e.session,e.user,i(v({m:s.m},r.custom))),n()}),null!=o&&(c.use("readSnapshots",function(e,n){var r,s=e.agent,t=e.collection,e=e.snapshots;return s.stream.ws?(r=1<e.length?null:e[0].id,o(v({id:r,collection:t,snapshots:e,type:"readSnapshots"},s.custom)).then(function(){return n()}).catch(function(e){return n(w(e))})):n()}),c.use("submit",function(e,n){var r=e.collection,s=e.agent,t=e.op,e=e.id;return s.stream.ws?o(v({id:e,collection:r,op:t,type:"submit"},s.custom)).then(function(){return n()}).catch(function(e){return n(w(e))}):n()})),{server:e,sdb:c,connect:r,wss:u}}}.call(this);
