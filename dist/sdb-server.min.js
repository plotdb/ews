!function(){var a,l,m,d,p,h,f;function w(e,n){var r,t={}.hasOwnProperty;for(r in n)t.call(n,r)&&(e[r]=n[r]);return e}a=require("sharedb"),l=require("@plotdb/sharedb-postgres"),m=require("sharedb-pg-mdb"),d=require("ws"),p=require("http"),h=require("websocket-json-stream"),f=require("./index"),module.exports=function(e){var n=e.app,r=e.io,s=e.session,o=e.access,t=e.milestoneDb,u=e.wss,c=e.metadata,e=null,t=t&&t.enabled?new m({ioPg:r,interval:t.interval||250}):null,i=new a({db:l(r),milestoneDb:t}),r=i.connect();return u||(e=p.createServer(n),u=new d.Server({server:e})),u.on("connection",function(e,r){var n=null!=s?new Promise(function(e,n){return s(r,{},function(){return e()})}):Promise.resolve(),t=new f({ws:e,scope:"sharedb"});return n.then(function(){return i.listen(h(t),r)}).catch(function(e){return console.log("[sdb-server] wss on connection error: ",e.message,e)}),e.on("close",function(){})}),i.use("connect",function(e,n){var r,t=e.agent,s=e.req,e=e.stream;return s&&e.ws&&(r=(e=s.session)&&e.passport&&e.passport.user||{},(t=t.custom).req=s,t.session=e,t.user=r),n()}),null!=c&&i.use("commit",function(e,n){e.collection;var r=e.agent,t=(e.snapshot,e.op);e.id;return r.stream.ws&&((e=r.custom).req,e.session,e.user,c(w({m:t.m},r.custom))),n()}),null!=o&&(i.use("readSnapshots",function(e,n){var r,t=e.agent,s=e.collection,e=e.snapshots;return t.stream.ws?(r=1<e.length?null:e[0].id,o(w({id:r,collection:s,snapshots:e,type:"readSnapshots"},t.custom)).then(function(){return n()}).catch(function(e){return n(e||((e=new Error).name="lderror",e.id=1012,e))})):n()}),i.use("submit",function(e,n){var r=e.collection,t=e.agent,e=e.id;return t.stream.ws?o(w({id:e,collection:r,type:"submit"},t.custom)).then(function(){return n()}).catch(function(e){return n(e||((e=new Error).name="lderror",e.id=1012,e))}):n()})),{server:e,sdb:i,connect:r,wss:u}}}.call(this);
